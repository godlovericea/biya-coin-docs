# ğŸ—‚ï¸ çŠ¶æ€ç®¡ç†ç­–ç•¥

> **æ ¸å¿ƒå†…å®¹**: Zustand çŠ¶æ€ç®¡ç†çš„åˆ†å±‚è®¾è®¡ä¸æœ€ä½³å®è·µ  
> **ç›®æ ‡**: åŒºåˆ†å…±äº«çŠ¶æ€å’Œåº”ç”¨ç‰¹å®šçŠ¶æ€ï¼Œå®ç°é«˜æ•ˆçš„çŠ¶æ€ç®¡ç†  
> **æ›´æ–°æ—¶é—´**: 2025-10-31

---

## ğŸ“– ç›®å½•

1. [çŠ¶æ€åˆ†å±‚ç­–ç•¥](#çŠ¶æ€åˆ†å±‚ç­–ç•¥)
2. [å…±äº«çŠ¶æ€è®¾è®¡](#å…±äº«çŠ¶æ€è®¾è®¡)
3. [åº”ç”¨ç‰¹å®šçŠ¶æ€](#åº”ç”¨ç‰¹å®šçŠ¶æ€)
4. [çŠ¶æ€æŒä¹…åŒ–](#çŠ¶æ€æŒä¹…åŒ–)
5. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
6. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ¯ çŠ¶æ€åˆ†å±‚ç­–ç•¥

### æ ¸å¿ƒåŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åº”ç”¨å±‚çŠ¶æ€                      â”‚
â”‚  (App-Specific State in apps/*/store/)         â”‚
â”‚  â”œâ”€â”€ Bridge: äº¤æ˜“å†å²ã€è¡¨å•çŠ¶æ€                 â”‚
â”‚  â”œâ”€â”€ DEX: è®¢å•ç°¿ã€äº¤æ˜“å¯¹                        â”‚
â”‚  â””â”€â”€ Helix: ç”¨æˆ·åå¥½ã€ä¸´æ—¶æ•°æ®                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–²
                      â”‚ å¼•ç”¨
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å…±äº«å±‚çŠ¶æ€                      â”‚
â”‚  (Shared State in packages/*/store/)           â”‚
â”‚  â”œâ”€â”€ @biya/theme: ä¸»é¢˜é…ç½®                      â”‚
â”‚  â”œâ”€â”€ @biya/wallet: é’±åŒ…è¿æ¥                     â”‚
â”‚  â””â”€â”€ @biya/auth: ç”¨æˆ·è®¤è¯                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å†³ç­–æ ‘

```
çŠ¶æ€éœ€è¦è·¨åº”ç”¨å…±äº«ï¼Ÿ
â”œâ”€ æ˜¯ â†’ æ”¾åœ¨å…±äº«åŒ…ä¸­ (packages/*/store/)
â”‚   â”œâ”€ ä¸»é¢˜è®¾ç½® â†’ @biya/theme
â”‚   â”œâ”€ é’±åŒ…è¿æ¥ â†’ @biya/wallet
â”‚   â”œâ”€ ç”¨æˆ·è®¤è¯ â†’ @biya/auth
â”‚   â””â”€ å…¶ä»–å…¨å±€çŠ¶æ€ â†’ @biya/shared/store
â”‚
â””â”€ å¦ â†’ æ”¾åœ¨åº”ç”¨ä¸­ (apps/*/store/)
    â”œâ”€ Bridge äº¤æ˜“è®°å½• â†’ apps/bridge/store
    â”œâ”€ DEX è®¢å•æ•°æ® â†’ apps/dex/store
    â””â”€ Helix ç‰¹å®šçŠ¶æ€ â†’ apps/helix/store
```

---

## ğŸŒ å…±äº«çŠ¶æ€è®¾è®¡

### 1. Theme Storeï¼ˆä¸»é¢˜çŠ¶æ€ï¼‰

```typescript
// packages/theme/store/theme-store.ts
import { create } from 'zustand'
import { persist, createJSONStorage } from 'zustand/middleware'

export type Theme = 'light' | 'dark' | 'system'

interface ThemeState {
  // çŠ¶æ€
  theme: Theme
  isDark: boolean
  
  // æ“ä½œ
  setTheme: (theme: Theme) => void
  toggleTheme: () => void
}

export const useThemeStore = create<ThemeState>()(
  persist(
    (set, get) => ({
      theme: 'system',
      isDark: false,
      
      setTheme: (theme) => {
        const root = document.documentElement
        const isDark = theme === 'dark' || 
          (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)
        
        root.classList.toggle('dark', isDark)
        set({ theme, isDark })
      },
      
      toggleTheme: () => {
        const current = get().theme
        const newTheme = current === 'dark' ? 'light' : 'dark'
        get().setTheme(newTheme)
      },
    }),
    {
      name: 'biya-theme-storage',
      storage: createJSONStorage(() => localStorage),
    }
  )
)

// å¯¼å‡ºé€‰æ‹©å™¨ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
export const selectTheme = (state: ThemeState) => state.theme
export const selectIsDark = (state: ThemeState) => state.isDark
```

---

### 2. Wallet Storeï¼ˆé’±åŒ…çŠ¶æ€ï¼‰

```typescript
// packages/wallet/store/wallet-store.ts
import { create } from 'zustand'
import { persist, createJSONStorage } from 'zustand/middleware'

interface WalletState {
  // EVM é’±åŒ…
  address: string | null
  chainId: number | null
  
  // Injective é’±åŒ…
  injectiveAddress: string | null
  
  // çŠ¶æ€
  isConnected: boolean
  isConnecting: boolean
  
  // ä½™é¢
  balance: string | null
  
  // æ“ä½œ
  connect: () => Promise<void>
  disconnect: () => void
  setAddress: (address: string | null) => void
  setInjectiveAddress: (address: string | null) => void
  setChainId: (chainId: number | null) => void
  setBalance: (balance: string | null) => void
  reset: () => void
}

export const useWalletStore = create<WalletState>()(
  persist(
    (set) => ({
      // åˆå§‹çŠ¶æ€
      address: null,
      chainId: null,
      injectiveAddress: null,
      isConnected: false,
      isConnecting: false,
      balance: null,
      
      // è¿æ¥é’±åŒ…
      connect: async () => {
        set({ isConnecting: true })
        try {
          // è¿æ¥é€»è¾‘
          // const { address, chainId } = await connectWallet()
          // set({ address, chainId, isConnected: true })
        } catch (error) {
          console.error('Failed to connect wallet:', error)
          throw error
        } finally {
          set({ isConnecting: false })
        }
      },
      
      // æ–­å¼€è¿æ¥
      disconnect: () => {
        set({
          address: null,
          chainId: null,
          injectiveAddress: null,
          isConnected: false,
          balance: null,
        })
      },
      
      // Setters
      setAddress: (address) => set({ address, isConnected: !!address }),
      setInjectiveAddress: (injectiveAddress) => set({ injectiveAddress }),
      setChainId: (chainId) => set({ chainId }),
      setBalance: (balance) => set({ balance }),
      
      // é‡ç½®
      reset: () => {
        set({
          address: null,
          chainId: null,
          injectiveAddress: null,
          isConnected: false,
          isConnecting: false,
          balance: null,
        })
      },
    }),
    {
      name: 'biya-wallet-storage',
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        address: state.address,
        chainId: state.chainId,
        injectiveAddress: state.injectiveAddress,
      }),
    }
  )
)

// é€‰æ‹©å™¨
export const selectAddress = (state: WalletState) => state.address
export const selectIsConnected = (state: WalletState) => state.isConnected
export const selectBalance = (state: WalletState) => state.balance
```

---

### 3. Auth Storeï¼ˆè®¤è¯çŠ¶æ€ï¼‰

```typescript
// packages/auth/store/auth-store.ts
import { create } from 'zustand'
import { persist, createJSONStorage } from 'zustand/middleware'

interface User {
  id: string
  email: string
  name: string
  avatar?: string
}

interface AuthState {
  // ç”¨æˆ·ä¿¡æ¯
  user: User | null
  token: string | null
  
  // çŠ¶æ€
  isAuthenticated: boolean
  isLoading: boolean
  
  // æ“ä½œ
  login: (email: string, password: string) => Promise<void>
  logout: () => void
  setUser: (user: User | null) => void
  setToken: (token: string | null) => void
  refreshToken: () => Promise<void>
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      // åˆå§‹çŠ¶æ€
      user: null,
      token: null,
      isAuthenticated: false,
      isLoading: false,
      
      // ç™»å½•
      login: async (email, password) => {
        set({ isLoading: true })
        try {
          // const response = await authService.login(email, password)
          // set({
          //   user: response.user,
          //   token: response.token,
          //   isAuthenticated: true,
          // })
        } catch (error) {
          console.error('Login failed:', error)
          throw error
        } finally {
          set({ isLoading: false })
        }
      },
      
      // ç™»å‡º
      logout: () => {
        set({
          user: null,
          token: null,
          isAuthenticated: false,
        })
      },
      
      // Setters
      setUser: (user) => set({ user, isAuthenticated: !!user }),
      setToken: (token) => set({ token }),
      
      // åˆ·æ–° Token
      refreshToken: async () => {
        const currentToken = get().token
        if (!currentToken) return
        
        try {
          // const newToken = await authService.refreshToken(currentToken)
          // set({ token: newToken })
        } catch (error) {
          console.error('Failed to refresh token:', error)
          get().logout()
        }
      },
    }),
    {
      name: 'biya-auth-storage',
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        user: state.user,
        token: state.token,
      }),
    }
  )
)

// é€‰æ‹©å™¨
export const selectUser = (state: AuthState) => state.user
export const selectIsAuthenticated = (state: AuthState) => state.isAuthenticated
export const selectToken = (state: AuthState) => state.token
```

---

## ğŸ® åº”ç”¨ç‰¹å®šçŠ¶æ€

### 1. Bridge App State

```typescript
// apps/bridge/store/bridge-store.ts
import { create } from 'zustand'

interface BridgeTransaction {
  id: string
  from: string
  to: string
  amount: string
  token: string
  status: 'pending' | 'completed' | 'failed'
  timestamp: number
  txHash?: string
}

interface BridgeState {
  // äº¤æ˜“å†å²
  transactions: BridgeTransaction[]
  
  // è¡¨å•çŠ¶æ€
  fromChain: string
  toChain: string
  selectedToken: string
  amount: string
  
  // UI çŠ¶æ€
  isTransferring: boolean
  showHistory: boolean
  
  // æ“ä½œ
  addTransaction: (tx: BridgeTransaction) => void
  updateTransaction: (id: string, updates: Partial<BridgeTransaction>) => void
  setFromChain: (chain: string) => void
  setToChain: (chain: string) => void
  setSelectedToken: (token: string) => void
  setAmount: (amount: string) => void
  setTransferring: (transferring: boolean) => void
  toggleHistory: () => void
  reset: () => void
}

export const useBridgeStore = create<BridgeState>((set) => ({
  // åˆå§‹çŠ¶æ€
  transactions: [],
  fromChain: 'ethereum',
  toChain: 'injective',
  selectedToken: 'USDT',
  amount: '',
  isTransferring: false,
  showHistory: false,
  
  // äº¤æ˜“æ“ä½œ
  addTransaction: (tx) => set((state) => ({
    transactions: [tx, ...state.transactions],
  })),
  
  updateTransaction: (id, updates) => set((state) => ({
    transactions: state.transactions.map((tx) =>
      tx.id === id ? { ...tx, ...updates } : tx
    ),
  })),
  
  // è¡¨å•æ“ä½œ
  setFromChain: (fromChain) => set({ fromChain }),
  setToChain: (toChain) => set({ toChain }),
  setSelectedToken: (selectedToken) => set({ selectedToken }),
  setAmount: (amount) => set({ amount }),
  
  // UI æ“ä½œ
  setTransferring: (isTransferring) => set({ isTransferring }),
  toggleHistory: () => set((state) => ({ showHistory: !state.showHistory })),
  
  // é‡ç½®
  reset: () => set({
    fromChain: 'ethereum',
    toChain: 'injective',
    selectedToken: 'USDT',
    amount: '',
    isTransferring: false,
  }),
}))

// é€‰æ‹©å™¨
export const selectTransactions = (state: BridgeState) => state.transactions
export const selectIsTransferring = (state: BridgeState) => state.isTransferring
```

---

### 2. DEX App State

```typescript
// apps/dex/store/dex-store.ts
import { create } from 'zustand'

interface Order {
  id: string
  type: 'buy' | 'sell'
  price: string
  amount: string
  total: string
  timestamp: number
  status: 'pending' | 'filled' | 'cancelled'
}

interface DexState {
  // äº¤æ˜“å¯¹
  baseCurrency: string
  quoteCurrency: string
  
  // è®¢å•ç°¿
  buyOrders: Order[]
  sellOrders: Order[]
  
  // ç”¨æˆ·è®¢å•
  myOrders: Order[]
  
  // è¡¨å•çŠ¶æ€
  orderType: 'buy' | 'sell'
  price: string
  amount: string
  
  // UI çŠ¶æ€
  isPlacingOrder: boolean
  
  // æ“ä½œ
  setTradingPair: (base: string, quote: string) => void
  setBuyOrders: (orders: Order[]) => void
  setSellOrders: (orders: Order[]) => void
  addMyOrder: (order: Order) => void
  updateMyOrder: (id: string, updates: Partial<Order>) => void
  setOrderType: (type: 'buy' | 'sell') => void
  setPrice: (price: string) => void
  setAmount: (amount: string) => void
  setPlacingOrder: (placing: boolean) => void
  reset: () => void
}

export const useDexStore = create<DexState>((set) => ({
  // åˆå§‹çŠ¶æ€
  baseCurrency: 'INJ',
  quoteCurrency: 'USDT',
  buyOrders: [],
  sellOrders: [],
  myOrders: [],
  orderType: 'buy',
  price: '',
  amount: '',
  isPlacingOrder: false,
  
  // äº¤æ˜“å¯¹æ“ä½œ
  setTradingPair: (baseCurrency, quoteCurrency) => set({ baseCurrency, quoteCurrency }),
  
  // è®¢å•ç°¿æ“ä½œ
  setBuyOrders: (buyOrders) => set({ buyOrders }),
  setSellOrders: (sellOrders) => set({ sellOrders }),
  
  // ç”¨æˆ·è®¢å•æ“ä½œ
  addMyOrder: (order) => set((state) => ({
    myOrders: [order, ...state.myOrders],
  })),
  
  updateMyOrder: (id, updates) => set((state) => ({
    myOrders: state.myOrders.map((order) =>
      order.id === id ? { ...order, ...updates } : order
    ),
  })),
  
  // è¡¨å•æ“ä½œ
  setOrderType: (orderType) => set({ orderType }),
  setPrice: (price) => set({ price }),
  setAmount: (amount) => set({ amount }),
  
  // UI æ“ä½œ
  setPlacingOrder: (isPlacingOrder) => set({ isPlacingOrder }),
  
  // é‡ç½®
  reset: () => set({
    orderType: 'buy',
    price: '',
    amount: '',
    isPlacingOrder: false,
  }),
}))

// é€‰æ‹©å™¨
export const selectBuyOrders = (state: DexState) => state.buyOrders
export const selectSellOrders = (state: DexState) => state.sellOrders
export const selectMyOrders = (state: DexState) => state.myOrders
```

---

### 3. Helix App State

```typescript
// apps/helix/store/helix-store.ts
import { create } from 'zustand'
import { persist, createJSONStorage } from 'zustand/middleware'

interface HelixState {
  // ç”¨æˆ·åå¥½
  defaultView: 'simple' | 'advanced'
  showTutorial: boolean
  favoriteTokens: string[]
  
  // UI çŠ¶æ€
  sidebarOpen: boolean
  
  // æ“ä½œ
  setDefaultView: (view: 'simple' | 'advanced') => void
  setShowTutorial: (show: boolean) => void
  addFavoriteToken: (token: string) => void
  removeFavoriteToken: (token: string) => void
  toggleSidebar: () => void
}

export const useHelixStore = create<HelixState>()(
  persist(
    (set) => ({
      // åˆå§‹çŠ¶æ€
      defaultView: 'simple',
      showTutorial: true,
      favoriteTokens: [],
      sidebarOpen: true,
      
      // æ“ä½œ
      setDefaultView: (defaultView) => set({ defaultView }),
      setShowTutorial: (showTutorial) => set({ showTutorial }),
      
      addFavoriteToken: (token) => set((state) => ({
        favoriteTokens: [...state.favoriteTokens, token],
      })),
      
      removeFavoriteToken: (token) => set((state) => ({
        favoriteTokens: state.favoriteTokens.filter((t) => t !== token),
      })),
      
      toggleSidebar: () => set((state) => ({
        sidebarOpen: !state.sidebarOpen,
      })),
    }),
    {
      name: 'helix-storage',
      storage: createJSONStorage(() => localStorage),
    }
  )
)

// é€‰æ‹©å™¨
export const selectFavoriteTokens = (state: HelixState) => state.favoriteTokens
export const selectSidebarOpen = (state: HelixState) => state.sidebarOpen
```

---

## ğŸ’¾ çŠ¶æ€æŒä¹…åŒ–

### 1. æŒä¹…åŒ–ç­–ç•¥

```typescript
// æŒä¹…åŒ–æ‰€æœ‰çŠ¶æ€ï¼ˆé»˜è®¤ï¼‰
persist(
  (set) => ({ /* ... */ }),
  {
    name: 'storage-key',
    storage: createJSONStorage(() => localStorage),
  }
)

// éƒ¨åˆ†æŒä¹…åŒ–
persist(
  (set) => ({ /* ... */ }),
  {
    name: 'storage-key',
    storage: createJSONStorage(() => localStorage),
    partialize: (state) => ({
      // åªæŒä¹…åŒ–è¿™äº›å­—æ®µ
      theme: state.theme,
      user: state.user,
    }),
  }
)

// ä¸æŒä¹…åŒ–
create<State>((set) => ({ /* ... */ }))
```

---

### 2. æŒä¹…åŒ–æ¸…å•

| Store | æŒä¹…åŒ– | åŸå›  |
|-------|--------|------|
| `@biya/theme` | âœ… å…¨éƒ¨ | ä¿æŒç”¨æˆ·ä¸»é¢˜åå¥½ |
| `@biya/wallet` | âœ… éƒ¨åˆ† | ä¿å­˜åœ°å€ï¼Œä¸ä¿å­˜ä½™é¢ |
| `@biya/auth` | âœ… éƒ¨åˆ† | ä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œ Token |
| `bridge-store` | âŒ æ—  | äº¤æ˜“å†å²ä¸éœ€è¦æŒä¹…åŒ– |
| `dex-store` | âŒ æ—  | è®¢å•æ•°æ®å®æ—¶è·å– |
| `helix-store` | âœ… å…¨éƒ¨ | ä¿å­˜ç”¨æˆ·åå¥½ |

---

### 3. è‡ªå®šä¹‰å­˜å‚¨

```typescript
// ä½¿ç”¨ sessionStorage
import { persist, createJSONStorage } from 'zustand/middleware'

export const useSessionStore = create<State>()(
  persist(
    (set) => ({ /* ... */ }),
    {
      name: 'session-storage',
      storage: createJSONStorage(() => sessionStorage),
    }
  )
)

// ä½¿ç”¨ IndexedDBï¼ˆå¤§æ•°æ®ï¼‰
import { persist } from 'zustand/middleware'
import { get, set, del } from 'idb-keyval'

export const useIndexedDBStore = create<State>()(
  persist(
    (set) => ({ /* ... */ }),
    {
      name: 'indexed-db-storage',
      storage: {
        getItem: async (name) => {
          return (await get(name)) || null
        },
        setItem: async (name, value) => {
          await set(name, value)
        },
        removeItem: async (name) => {
          await del(name)
        },
      },
    }
  )
)

// ä½¿ç”¨ Cookieï¼ˆéœ€è¦ SSRï¼‰
import Cookies from 'js-cookie'

export const useCookieStore = create<State>()(
  persist(
    (set) => ({ /* ... */ }),
    {
      name: 'cookie-storage',
      storage: {
        getItem: (name) => {
          const value = Cookies.get(name)
          return value ? JSON.parse(value) : null
        },
        setItem: (name, value) => {
          Cookies.set(name, JSON.stringify(value), { expires: 7 })
        },
        removeItem: (name) => {
          Cookies.remove(name)
        },
      },
    }
  )
)
```

---

### 4. å­˜å‚¨ä½ç½®å¯¹æ¯”

#### é»˜è®¤ï¼šlocalStorageï¼ˆæ¨èï¼‰âœ…

```typescript
export const useStore = create()(
  persist(
    (set) => ({
      count: 0,
      increment: () => set((state) => ({ count: state.count + 1 })),
    }),
    {
      name: 'my-storage',  // ğŸ‘ˆ localStorage çš„ key
      storage: createJSONStorage(() => localStorage),  // é»˜è®¤
    }
  )
)
```

**å­˜å‚¨ä½ç½®**ï¼šæµè§ˆå™¨ `localStorage`

**æŸ¥çœ‹æ•°æ®**ï¼š
```javascript
// å¼€å‘è€…å·¥å…· â†’ Application â†’ Local Storage
localStorage.getItem('my-storage')
// è¾“å‡ºï¼š{"state":{"count":5},"version":0}
```

**åˆ·æ–°å**ï¼šâœ… **ä¸ä¼šä¸¢å¤±**ï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰  
**å…³é—­æ ‡ç­¾å**ï¼šâœ… **ä¸ä¼šä¸¢å¤±**  
**è·¨æ ‡ç­¾å…±äº«**ï¼šâœ… **æ˜¯**ï¼ˆåŒæºæ ‡ç­¾é¡µå…±äº«æ•°æ®ï¼‰

---

#### å®Œæ•´å¯¹æ¯”è¡¨æ ¼

| å­˜å‚¨æ–¹å¼ | å¤§å°é™åˆ¶ | åˆ·æ–°å | å…³é—­æ ‡ç­¾å | è·¨æ ‡ç­¾å…±äº« | SSR å¯è¯» | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|---------|---------|--------|-----------|----------|----------|------|---------|
| **localStorage** | ~5-10MB | âœ… ä¿ç•™ | âœ… ä¿ç•™ | âœ… æ˜¯ | âŒ å¦ | å¿« | ğŸ‘‰ **æ¨è**ï¼ˆç”¨æˆ·åå¥½ï¼‰ |
| **sessionStorage** | ~5-10MB | âœ… ä¿ç•™ | âŒ ä¸¢å¤± | âŒ å¦ | âŒ å¦ | å¿« | ä¸´æ—¶ä¼šè¯æ•°æ® |
| **Cookie** | 4KB | âœ… ä¿ç•™ | âœ… ä¿ç•™ | âœ… æ˜¯ | âœ… æ˜¯ | ä¸­ | éœ€è¦ SSR è¯»å– |
| **IndexedDB** | GB+ | âœ… ä¿ç•™ | âœ… ä¿ç•™ | âœ… æ˜¯ | âŒ å¦ | å¼‚æ­¥ | å¤§é‡æ•°æ®ã€ç¦»çº¿å­˜å‚¨ |
| **ä¸æŒä¹…åŒ–** | - | âŒ ä¸¢å¤± | âŒ ä¸¢å¤± | âŒ å¦ | âŒ å¦ | - | ä¸´æ—¶ UI çŠ¶æ€ |

---

### 5. å®é™…å­˜å‚¨ç¤ºä¾‹

#### ç¤ºä¾‹ 1ï¼šå®Œæ•´æŒä¹…åŒ–ï¼ˆä¸»é¢˜ï¼‰

```typescript
// packages/theme/store/theme-store.ts
export const useThemeStore = create()(
  persist(
    (set) => ({
      theme: 'light',
      setTheme: (theme) => set({ theme }),
    }),
    {
      name: 'biya-theme-storage',  // localStorage key
      storage: createJSONStorage(() => localStorage),
    }
  )
)
```

**æµè§ˆå™¨å­˜å‚¨**ï¼š
```json
// localStorage['biya-theme-storage']
{
  "state": {
    "theme": "dark"
  },
  "version": 0
}
```

**åˆ·æ–°åè¡Œä¸º**ï¼š
- âœ… ä¸»é¢˜ä¿æŒä¸º `"dark"`
- âœ… ç”¨æˆ·åå¥½è¢«è®°ä½
- âœ… è·¨æ ‡ç­¾é¡µç”Ÿæ•ˆ

---

#### ç¤ºä¾‹ 2ï¼šéƒ¨åˆ†æŒä¹…åŒ–ï¼ˆé’±åŒ…ï¼‰

```typescript
// packages/wallet/store/wallet-store.ts
export const useWalletStore = create()(
  persist(
    (set) => ({
      address: null,
      balance: '0',
      isConnected: false,
      network: 'mainnet',
    }),
    {
      name: 'biya-wallet-storage',
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        address: state.address,    // âœ… æŒä¹…åŒ–ï¼ˆè®°ä½åœ°å€ï¼‰
        network: state.network,    // âœ… æŒä¹…åŒ–ï¼ˆè®°ä½ç½‘ç»œï¼‰
        // balance: ä¸æŒä¹…åŒ–       // âŒ æ¯æ¬¡åˆ·æ–°é‡æ–°è·å–
        // isConnected: ä¸æŒä¹…åŒ–   // âŒ éœ€è¦é‡æ–°è¿æ¥
      }),
    }
  )
)
```

**æµè§ˆå™¨å­˜å‚¨**ï¼š
```json
// localStorage['biya-wallet-storage']
{
  "state": {
    "address": "0x1234...5678",
    "network": "mainnet"
  },
  "version": 0
}
```

**åˆ·æ–°åè¡Œä¸º**ï¼š
- âœ… `address` ä¿ç•™ï¼š`"0x1234...5678"`
- âœ… `network` ä¿ç•™ï¼š`"mainnet"`
- âŒ `balance` é‡ç½®ä¸ºï¼š`"0"`ï¼ˆéœ€è¦é‡æ–°æŸ¥è¯¢ï¼‰
- âŒ `isConnected` é‡ç½®ä¸ºï¼š`false`ï¼ˆéœ€è¦é‡æ–°è¿æ¥ï¼‰

---

#### ç¤ºä¾‹ 3ï¼šä¸æŒä¹…åŒ–ï¼ˆä¸´æ—¶ UI çŠ¶æ€ï¼‰

```typescript
// apps/bridge/store/bridge-store.ts
export const useBridgeStore = create<State>((set) => ({
  fromChain: 'ethereum',
  toChain: 'injective',
  amount: '',
  isTransferring: false,
  // ğŸ‘ˆ æ²¡æœ‰ persist() åŒ…è£¹
}))
```

**åˆ·æ–°åè¡Œä¸º**ï¼š
- âŒ æ‰€æœ‰çŠ¶æ€ä¸¢å¤±
- âŒ æ¢å¤åˆ°åˆå§‹å€¼
- âœ… é€‚åˆè¡¨å•æ•°æ®ï¼ˆç”¨æˆ·æ¯æ¬¡æ‰‹åŠ¨è¾“å…¥ï¼‰

---

### 6. Next.js App Router ä¸­çš„ä½¿ç”¨ âš ï¸

#### å…³é”®ç‚¹ï¼šå¿…é¡»ä½¿ç”¨ `'use client'`

```typescript
// âŒ é”™è¯¯ï¼šServer Component æ— æ³•ä½¿ç”¨ Zustand
// app/page.tsx
export default function Page() {
  const theme = useThemeStore((state) => state.theme)  // æŠ¥é”™ï¼
  return <div>{theme}</div>
}

// âœ… æ­£ç¡®ï¼šClient Component
'use client'  // ğŸ‘ˆ å¿…é¡»åŠ è¿™ä¸€è¡Œ

export default function Page() {
  const theme = useThemeStore((state) => state.theme)  // OK
  return <div>{theme}</div>
}
```

**ä¸ºä»€ä¹ˆå¿…é¡»åŠ  `'use client'`**ï¼š
1. âœ… Zustand ä½¿ç”¨ React Hooksï¼ˆ`useState`ã€`useEffect`ï¼‰
2. âœ… Hooks åªèƒ½åœ¨ Client Components ä¸­è¿è¡Œ
3. âœ… `persist` éœ€è¦è®¿é—® `localStorage`ï¼ˆæµè§ˆå™¨ APIï¼‰
4. âœ… Server Components æ— æ³•è®¿é—®æµè§ˆå™¨ API

---

#### é¿å… SSR/CSR ä¸åŒ¹é…

```typescript
'use client'

import { useEffect, useState } from 'react'
import { useThemeStore } from '@biya/theme'

export function ThemeToggle() {
  const [mounted, setMounted] = useState(false)
  const { theme, setTheme } = useThemeStore()

  // ç­‰å¾…å®¢æˆ·ç«¯æŒ‚è½½
  useEffect(() => {
    setMounted(true)
  }, [])

  // æœåŠ¡å™¨ç«¯æ¸²æŸ“æ—¶è¿”å›å ä½ç¬¦
  if (!mounted) {
    return <div className="w-10 h-10" />  // å ä½ç¬¦ï¼Œé¿å…é—ªçƒ
  }

  // å®¢æˆ·ç«¯æ¸²æŸ“æ—¶æ˜¾ç¤ºçœŸå®å†…å®¹
  return (
    <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')}>
      {theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸'}
    </button>
  )
}
```

**åŸç†**ï¼š
1. æœåŠ¡å™¨ç«¯ï¼š`mounted = false` â†’ æ¸²æŸ“å ä½ç¬¦
2. å®¢æˆ·ç«¯ï¼š`useEffect` æ‰§è¡Œ â†’ `mounted = true` â†’ æ¸²æŸ“çœŸå®å†…å®¹
3. é¿å…ï¼šæœåŠ¡å™¨ HTML â‰  å®¢æˆ·ç«¯åˆå§‹ HTMLï¼ˆæ°´åˆé”™è¯¯ï¼‰

---

#### Store å®šä¹‰ä¸éœ€è¦ `'use client'`

```typescript
// packages/theme/store/theme-store.ts
// âœ… ä¸éœ€è¦ 'use client'ï¼ˆè¿™æ˜¯å®šä¹‰ï¼Œä¸æ˜¯ä½¿ç”¨ï¼‰
import { create } from 'zustand'
import { persist, createJSONStorage } from 'zustand/middleware'

export const useThemeStore = create()(
  persist(
    (set) => ({
      theme: 'light',
      setTheme: (theme) => set({ theme }),
    }),
    {
      name: 'biya-theme-storage',
      storage: createJSONStorage(() => localStorage),
    }
  )
)
```

```typescript
// apps/helix/components/ThemeToggle.tsx
'use client'  // ğŸ‘ˆ ä½¿ç”¨ Store çš„ç»„ä»¶éœ€è¦

import { useThemeStore } from '@biya/theme'

export function ThemeToggle() {
  const { theme, setTheme } = useThemeStore()  // ä½¿ç”¨ Store
  // ...
}
```

---

### 7. æŒä¹…åŒ–æœ€ä½³å®è·µ

#### âœ… æ¨èæŒä¹…åŒ–

```typescript
// 1. ç”¨æˆ·åå¥½ï¼ˆä¸»é¢˜ã€è¯­è¨€ã€å¸ƒå±€ï¼‰
const useThemeStore = create()(
  persist(
    (set) => ({ theme: 'light' }),
    { name: 'theme' }
  )
)

// 2. è®¤è¯ä¿¡æ¯ï¼ˆtokenã€ç”¨æˆ·ä¿¡æ¯ï¼‰
const useAuthStore = create()(
  persist(
    (set) => ({ token: null, user: null }),
    { 
      name: 'auth',
      partialize: (state) => ({ token: state.token, user: state.user })
    }
  )
)

// 3. ç”¨æˆ·è¾“å…¥ï¼ˆè‰ç¨¿ã€æ”¶è—ï¼‰
const useDraftStore = create()(
  persist(
    (set) => ({ drafts: [] }),
    { name: 'drafts' }
  )
)
```

---

#### âŒ ä¸æ¨èæŒä¹…åŒ–

```typescript
// 1. å®æ—¶æ•°æ®ï¼ˆä½™é¢ã€è®¢å•ã€ä»·æ ¼ï¼‰
const useWalletStore = create()(
  persist(
    (set) => ({ 
      address: null,   // âœ… æŒä¹…åŒ–
      balance: '0'     // âŒ ä¸æŒä¹…åŒ–ï¼ˆæ¯æ¬¡é‡æ–°è·å–ï¼‰
    }),
    {
      name: 'wallet',
      partialize: (state) => ({ address: state.address })
    }
  )
)

// 2. ä¸´æ—¶ UI çŠ¶æ€ï¼ˆæ¨¡æ€æ¡†ã€ä¸‹æ‹‰èœå•ï¼‰
const useUIStore = create<State>((set) => ({
  isModalOpen: false,
  // ä¸æŒä¹…åŒ–
}))

// 3. æ•æ„Ÿæ•°æ®ï¼ˆå¯†ç ã€ç§é’¥ï¼‰
// âš ï¸ æ°¸è¿œä¸è¦åœ¨å‰ç«¯æŒä¹…åŒ–æ•æ„Ÿæ•°æ®ï¼
```

---

### 8. è°ƒè¯•æŒä¹…åŒ–æ•°æ®

#### æ–¹æ³• 1ï¼šæµè§ˆå™¨å¼€å‘è€…å·¥å…·

```bash
# Chrome DevTools
1. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. Application â†’ Local Storage â†’ https://yourdomain.com
3. æ‰¾åˆ°å¯¹åº”çš„ keyï¼ˆå¦‚ 'biya-theme-storage'ï¼‰
4. æŸ¥çœ‹æˆ–ç¼–è¾‘ JSON æ•°æ®
```

---

#### æ–¹æ³• 2ï¼šJavaScript Console

```javascript
// æŸ¥çœ‹æ•°æ®
localStorage.getItem('biya-theme-storage')

// æ¸…é™¤æ•°æ®
localStorage.removeItem('biya-theme-storage')

// æ¸…é™¤æ‰€æœ‰ localStorage
localStorage.clear()

// æŸ¥çœ‹æ‰€æœ‰ keys
Object.keys(localStorage)
```

---

#### æ–¹æ³• 3ï¼šZustand DevTools

```typescript
import { devtools, persist } from 'zustand/middleware'

export const useStore = create()(
  devtools(  // ğŸ‘ˆ å¯ç”¨ DevTools
    persist(
      (set) => ({ /* ... */ }),
      { name: 'storage-key' }
    ),
    { name: 'MyStore' }  // DevTools ä¸­çš„åç§°
  )
)
```

å®‰è£… Redux DevTools Extension åå¯ä»¥æŸ¥çœ‹å’Œè°ƒè¯•ã€‚

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. ä½¿ç”¨é€‰æ‹©å™¨

```typescript
// âŒ ä¸å¥½ï¼šç»„ä»¶ä¼šåœ¨ä»»ä½•çŠ¶æ€å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“
function Component() {
  const store = useWalletStore()
  return <div>{store.address}</div>
}

// âœ… å¥½ï¼šåªåœ¨ address å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“
function Component() {
  const address = useWalletStore((state) => state.address)
  return <div>{address}</div>
}

// âœ… æ›´å¥½ï¼šä½¿ç”¨å¯¼å‡ºçš„é€‰æ‹©å™¨
import { useWalletStore, selectAddress } from '@biya/wallet'

function Component() {
  const address = useWalletStore(selectAddress)
  return <div>{address}</div>
}
```

---

### 2. ç»„åˆå¤šä¸ªé€‰æ‹©å™¨

```typescript
// âŒ ä¸å¥½ï¼šå¤šæ¬¡è®¢é˜…
function Component() {
  const address = useWalletStore((state) => state.address)
  const balance = useWalletStore((state) => state.balance)
  const isConnected = useWalletStore((state) => state.isConnected)
  // ...
}

// âœ… å¥½ï¼šä½¿ç”¨ shallow æ¯”è¾ƒ
import { shallow } from 'zustand/shallow'

function Component() {
  const { address, balance, isConnected } = useWalletStore(
    (state) => ({
      address: state.address,
      balance: state.balance,
      isConnected: state.isConnected,
    }),
    shallow
  )
  // ...
}
```

---

### 3. é¿å…å†…è”é€‰æ‹©å™¨

```typescript
// âŒ ä¸å¥½ï¼šæ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°å‡½æ•°
function Component() {
  const user = useAuthStore((state) => state.user)
  // ...
}

// âœ… å¥½ï¼šåœ¨ç»„ä»¶å¤–å®šä¹‰é€‰æ‹©å™¨
const selectUser = (state: AuthState) => state.user

function Component() {
  const user = useAuthStore(selectUser)
  // ...
}
```

---

### 4. ä½¿ç”¨ useShallow Hook

```typescript
// Zustand v4.4.0+ æä¾›çš„æ–° Hook
import { useShallow } from 'zustand/react/shallow'

function Component() {
  const { address, balance, isConnected } = useWalletStore(
    useShallow((state) => ({
      address: state.address,
      balance: state.balance,
      isConnected: state.isConnected,
    }))
  )
  // ...
}
```

---

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. çŠ¶æ€åˆ†å±‚åŸåˆ™

```typescript
// âœ… å…±äº«çŠ¶æ€ï¼šæ”¾åœ¨ packages/*/store/
// - ä¸»é¢˜ã€é’±åŒ…ã€è®¤è¯ç­‰è·¨åº”ç”¨çŠ¶æ€

// âœ… åº”ç”¨çŠ¶æ€ï¼šæ”¾åœ¨ apps/*/store/
// - åº”ç”¨ç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘å’Œ UI çŠ¶æ€

// âŒ é¿å…ï¼šåœ¨åº”ç”¨ä¸­åˆ›å»ºå…±äº«çŠ¶æ€
// âŒ é¿å…ï¼šåœ¨å…±äº«åŒ…ä¸­åˆ›å»ºåº”ç”¨ç‰¹å®šçŠ¶æ€
```

---

### 2. å•ä¸€èŒè´£

```typescript
// âœ… å¥½ï¼šæ¯ä¸ª Store åªç®¡ç†ä¸€ç±»çŠ¶æ€
const useThemeStore = create(/* åªç®¡ç†ä¸»é¢˜ */)
const useWalletStore = create(/* åªç®¡ç†é’±åŒ… */)
const useAuthStore = create(/* åªç®¡ç†è®¤è¯ */)

// âŒ ä¸å¥½ï¼šä¸€ä¸ª Store ç®¡ç†æ‰€æœ‰çŠ¶æ€
const useGlobalStore = create(/* ä¸»é¢˜ã€é’±åŒ…ã€è®¤è¯å…¨åœ¨è¿™é‡Œ */)
```

---

### 3. ç±»å‹å®‰å…¨

```typescript
// âœ… å§‹ç»ˆå®šä¹‰ TypeScript æ¥å£
interface WalletState {
  address: string | null
  isConnected: boolean
  connect: () => Promise<void>
  disconnect: () => void
}

export const useWalletStore = create<WalletState>()(/* ... */)
```

---

### 4. å¯¼å‡ºé€‰æ‹©å™¨

```typescript
// store/wallet-store.ts
export const useWalletStore = create<WalletState>()(/* ... */)

// å¯¼å‡ºå¸¸ç”¨é€‰æ‹©å™¨
export const selectAddress = (state: WalletState) => state.address
export const selectIsConnected = (state: WalletState) => state.isConnected
export const selectBalance = (state: WalletState) => state.balance

// ä½¿ç”¨æ—¶
import { useWalletStore, selectAddress } from '@biya/wallet'
const address = useWalletStore(selectAddress)
```

---

### 5. Actions å‘½åçº¦å®š

```typescript
interface State {
  // çŠ¶æ€ï¼šåè¯
  user: User | null
  isLoading: boolean
  
  // è®¾ç½®å™¨ï¼šsetXxx
  setUser: (user: User | null) => void
  setLoading: (loading: boolean) => void
  
  // åˆ‡æ¢å™¨ï¼štoggleXxx
  toggleSidebar: () => void
  
  // å¼‚æ­¥æ“ä½œï¼šåŠ¨è¯
  login: (email: string, password: string) => Promise<void>
  logout: () => void
  
  // é‡ç½®ï¼šreset
  reset: () => void
}
```

---

### 6. é”™è¯¯å¤„ç†

```typescript
export const useAuthStore = create<AuthState>((set) => ({
  login: async (email, password) => {
    set({ isLoading: true, error: null })
    try {
      const response = await authService.login(email, password)
      set({ user: response.user, isAuthenticated: true })
    } catch (error) {
      set({ error: error instanceof Error ? error.message : 'Login failed' })
      throw error
    } finally {
      set({ isLoading: false })
    }
  },
}))
```

---

### 7. DevTools é›†æˆ

```typescript
import { create } from 'zustand'
import { devtools } from 'zustand/middleware'

export const useWalletStore = create<WalletState>()(
  devtools(
    (set) => ({ /* ... */ }),
    { name: 'WalletStore' }
  )
)

// åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ Redux DevTools Extension æŸ¥çœ‹çŠ¶æ€å˜åŒ–
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

çŠ¶æ€ç®¡ç†ç­–ç•¥å·²æ˜ç¡®ï¼Œç»§ç»­é˜…è¯»ï¼š

**â†’ [06-å®æ–½æ­¥éª¤.md](./06-å®æ–½æ­¥éª¤.md)**

äº†è§£å¦‚ä½•ä¸€æ­¥æ­¥å°† `biya-helix-app` è¿ç§»åˆ° Monorepoã€‚

---

## ğŸ“š æœ¬ç« å°ç»“

### çŠ¶æ€åˆ†å±‚

1. **å…±äº«çŠ¶æ€**ï¼ˆpackages/*/store/ï¼‰
   - `@biya/theme`: ä¸»é¢˜é…ç½®
   - `@biya/wallet`: é’±åŒ…è¿æ¥
   - `@biya/auth`: ç”¨æˆ·è®¤è¯

2. **åº”ç”¨çŠ¶æ€**ï¼ˆapps/*/store/ï¼‰
   - `bridge-store`: äº¤æ˜“å†å²ã€è¡¨å•çŠ¶æ€
   - `dex-store`: è®¢å•ç°¿ã€ç”¨æˆ·è®¢å•
   - `helix-store`: ç”¨æˆ·åå¥½ã€UI çŠ¶æ€

### æ ¸å¿ƒåŸåˆ™

1. **å•ä¸€èŒè´£**: æ¯ä¸ª Store åªç®¡ç†ä¸€ç±»çŠ¶æ€
2. **ç±»å‹å®‰å…¨**: ä½¿ç”¨ TypeScript æ¥å£
3. **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨é€‰æ‹©å™¨å’Œ shallow æ¯”è¾ƒ
4. **æŒä¹…åŒ–**: åªæŒä¹…åŒ–å¿…è¦çš„çŠ¶æ€
5. **å¯æµ‹è¯•**: Actions æ˜¯çº¯å‡½æ•°

---

*æœ€åæ›´æ–°: 2025-10-31*

