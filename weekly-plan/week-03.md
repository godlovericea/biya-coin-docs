# Week 3: 鏈熻揣浜ゆ槗鏍稿績 (Day 15-21)

**涓婁竴鍛?*: [Week 2](./week-02.md) | **涓嬩竴鍛?*: [Week 4](./week-04.md)
## Week 3: 期货交易核心 (Day 15-21)

**目标**: 完整的期货交易功能（杠杆、做多做空、持仓管理）  
**负责人**: 2名高级开发  
**验收**: 可以开仓做多/做空，显示持仓，可以平仓

---

### Day 15: 期货市场与订单簿

**负责人**: 1名高级开发  
**工作时间**: 8小时

#### 任务15.1: 创建Derivatives Store (2小时)

**参考文件**: `injective-helix-demo/store/derivatives.ts`

**详细步骤**:
1. 创建derivatives store
   - 创建 `src/lib/store/derivativesStore.ts`
   - 定义状态类型（类似spot store但增加期货特有字段）
   - 杠杆设置
   - 保证金信息
   - 持仓列表
   - 资金费率

2. 实现市场切换
   - setMarket方法
   - 取消旧订阅
   - 订阅新市场（订单簿、成交、资金费率）

3. 实现订单簿订阅
   - 调用IndexerGrpcDerivativesApi
   - WebSocket订阅期货订单簿
   - 增量更新处理

4. 实现资金费率订阅
   - 获取当前资金费率
   - 获取历史资金费率
   - 显示下次结算时间

5. 测试store
   - 测试状态管理
   - 测试订阅
   - 测试数据更新

**交付物**:
- [ ] derivativesStore.ts
- [ ] DerivativesState类型
- [ ] 订阅管理方法

**验收标准**:
- Store功能正常
- 订阅数据正常
- 资金费率获取正确

---

#### 任务15.2: 期货订单簿与成交组件 (2小时)

**参考文件**: `injective-helix-demo/components/Partials/Trade/Derivatives/`

**详细步骤**:
1. 复用现货订单簿组件
   - 复制Orderbook组件
   - 调整数据源为derivatives store
   - 显示标记价格

2. 复用成交记录组件
   - 复制TradesList组件
   - 调整数据源

3. 添加期货特有信息
   - 显示资金费率
   - 显示标记价格 vs 最新价
   - 显示指数价格

4. 测试组件
   - 测试期货订单簿显示
   - 测试实时更新

**交付物**:
- [ ] 期货订单簿组件
- [ ] 期货成交记录组件

**验收标准**:
- 组件正确显示
- 期货特有信息准确
- 实时更新正常

---

#### 任务15.3: 创建持仓Service (2小时)

**参考文件**: `injective-helix-demo/app/services/derivatives.ts`

**详细步骤**:
1. 创建position service
   - 创建 `src/lib/services/position.service.ts`
   - 使用IndexerGrpcDerivativesApi

2. 实现获取持仓
   - fetchPositions方法
   - 按市场过滤
   - 按子账户过滤

3. 实现持仓实时订阅
   - WebSocket订阅持仓变化
   - 盈亏实时计算
   - 强平价实时更新

4. 实现平仓
   - 市价平仓
   - 限价平仓
   - 部分平仓
   - 全部平仓

5. 实现调整保证金
   - 增加保证金
   - 减少保证金
   - 计算保证金率变化

6. 测试service
   - 测试获取持仓
   - 测试平仓
   - 测试保证金调整

**交付物**:
- [ ] position.service.ts
- [ ] 持仓获取方法
- [ ] 平仓方法
- [ ] 保证金调整方法

**验收标准**:
- 持仓数据准确
- 平仓功能正常
- 保证金调整正确

---

#### 任务15.4: 杠杆与保证金计算 (2小时)

**参考文件**: `injective-helix-demo/app/utils/`

**详细步骤**:
1. 扩展calculations.ts
   - 添加期货计算函数

2. 保证金计算
   - 初始保证金计算公式
   - 维持保证金计算公式
   - 可用保证金计算
   - 保证金率计算

3. 强平价计算
   - 做多强平价公式
   - 做空强平价公式
   - 实时更新强平价

4. 盈亏计算
   - 未实现盈亏（Mark-to-Market）
   - 已实现盈亏
   - ROI计算

5. 资金费用计算
   - 每8小时资金费用
   - 累计资金费用

6. 单元测试
   - 测试所有计算函数
   - 对比Nuxt版本结果
   - 边界值测试

**交付物**:
- [ ] 期货计算函数
- [ ] 单元测试

**验收标准**:
- 计算准确无误
- 与Nuxt版本结果一致
- 测试覆盖全面

---

### Day 16-17: 期货下单表单

**负责人**: 1名高级开发 + 1名开发  
**工作时间**: 16小时

#### 任务16.1: 杠杆选择器组件 (2小时)

**参考文件**: `injective-helix-demo/components/Partials/Trade/Derivatives/`

**详细步骤**:
1. LeverageSelector组件
   - 创建 `src/components/trading/LeverageSelector.tsx`
   - Slider滑块选择1x-20x
   - 数字输入框
   - 显示最大可用杠杆

2. 强平价预览
   - 实时计算强平价
   - 做多/做空分别显示
   - 风险提示（接近强平时）

3. 保证金预览
   - 显示所需初始保证金
   - 显示维持保证金
   - 显示保证金率

4. 样式设计
   - 滑块视觉效果
   - 风险等级颜色（低、中、高）
   - 响应式布局

5. 测试组件
   - 测试杠杆选择
   - 测试计算准确性
   - 测试风险提示

**交付物**:
- [ ] LeverageSelector组件
- [ ] 强平价预览
- [ ] 保证金预览

**验收标准**:
- 杠杆选择流畅
- 计算实时准确
- 风险提示醒目
- UI美观

---

#### 任务16.2: 期货OrderForm组件 (6小时)

**参考文件**: `injective-helix-demo/components/Partials/Trade/Derivatives/OrderForm/`

**详细步骤**:
1. 复用现货OrderForm
   - 复制现货OrderForm代码
   - 调整为期货模式

2. 增加期货特有功能
   - 杠杆选择器集成
   - 做多/做空Tab（替换买/卖）
   - 仓位方向标识（Long/Short）

3. 保证金输入模式
   - 输入保证金金额
   - 或输入合约数量
   - 两种模式互相计算

4. 强平价显示
   - 实时显示预计强平价
   - 风险警告

5. 止盈止损（可选，简化版）
   - 止盈价格输入
   - 止损价格输入
   - 预期盈亏显示

6. 订单类型扩展
   - 限价单
   - 市价单
   - 止盈止损单（如果支持）

7. 表单验证
   - 杠杆范围验证
   - 保证金充足性验证
   - 价格合理性验证
   - 强平价风险验证

8. 提交流程
   - 构造期货订单消息
   - 确认Modal显示期货订单详情
   - 提交交易

9. 样式设计
   - 做多绿色主题
   - 做空红色主题
   - 风险警告红色高亮

10. 测试组件
    - 测试做多下单
    - 测试做空下单
    - 测试杠杆调整
    - 测试保证金计算
    - 测试强平价计算

**交付物**:
- [ ] 期货OrderForm组件
- [ ] 杠杆选择集成
- [ ] 保证金计算
- [ ] 强平价计算
- [ ] 完整提交流程

**验收标准**:
- 表单功能完整
- 计算准确
- 验证规则正确
- 提交流程正常
- UI美观清晰

---

#### 任务16.3: 期货Trading Service (3小时)

**参考文件**: `injective-helix-demo/app/services/derivatives.ts`

**详细步骤**:
1. 扩展trading service
   - 添加期货交易方法到trading.service.ts

2. 实现期货限价单
   - 构造MsgCreateDerivativeLimitOrder
   - 设置价格、数量、杠杆、方向
   - 签名并广播

3. 实现期货市价单
   - 构造MsgCreateDerivativeMarketOrder
   - 设置数量、杠杆、方向
   - 签名并广播

4. 实现平仓订单
   - 构造反向订单平仓
   - 市价平仓
   - 限价平仓

5. 实现止盈止损单（如果支持）
   - 构造条件订单
   - 设置触发条件

6. 错误处理
   - 保证金不足
   - 杠杆超限
   - 风险过高

7. 测试service
   - 单元测试
   - 集成测试（testnet）

**交付物**:
- [ ] 期货下单方法
- [ ] 平仓方法
- [ ] 止盈止损方法

**验收标准**:
- 期货订单可提交
- 平仓功能正常
- 错误处理完善

---

#### 任务16.4: 集成测试 (5小时)

**详细步骤**:
1. 功能测试
   - 测试做多开仓完整流程
   - 测试做空开仓完整流程
   - 测试限价单
   - 测试市价单
   - 测试杠杆调整
   - 测试保证金计算
   - 测试强平价计算

2. 边界测试
   - 保证金不足
   - 杠杆超限
   - 风险过高警告
   - 网络错误
   - 用户拒绝签名

3. UI测试
   - 测试响应式布局
   - 测试主题切换
   - 测试Tab切换
   - 测试风险提示显示

4. 修复Bug
   - 记录Bug
   - 修复
   - 回归测试

**交付物**:
- [ ] 测试报告
- [ ] Bug修复记录

**验收标准**:
- 核心流程测试通过
- 计算准确无误
- 无严重Bug

---

### Day 18-19: 持仓管理

**负责人**: 1名高级开发  
**工作时间**: 16小时

#### 任务18.1: PositionsList组件 (4小时)

**参考文件**: `injective-helix-demo/components/Partials/Portfolio/Positions/`

**详细步骤**:
1. PositionsList主组件
   - 创建 `src/components/portfolio/PositionsList.tsx`
   - 表格布局显示所有持仓

2. 表格列设计
   - 市场名称
   - 方向（Long/Short）
   - 杠杆
   - 持仓数量
   - 入场价格
   - 标记价格
   - 强平价格
   - 未实现盈亏（金额和百分比）
   - 保证金
   - 保证金率
   - 操作按钮（平仓、调整保证金、设置止盈止损）

3. 盈亏颜色
   - 盈利绿色
   - 亏损红色
   - 接近强平红色警告

4. 实时更新
   - 订阅持仓变化
   - 标记价格实时更新
   - 盈亏实时计算
   - 强平价实时更新

5. 排序和筛选
   - 按盈亏排序
   - 按市场筛选
   - 按方向筛选

6. 空状态
   - 无持仓时显示友好提示
   - 引导去开仓

7. 测试组件
   - 测试持仓列表显示
   - 测试实时更新
   - 测试排序筛选

**交付物**:
- [ ] PositionsList组件
- [ ] 实时更新逻辑

**验收标准**:
- 持仓信息完整准确
- 实时更新流畅
- 盈亏计算准确
- UI清晰美观

---

#### 任务18.2: 平仓功能 (3小时)

**详细步骤**:
1. 平仓按钮
   - 在持仓列表添加平仓按钮
   - 快速市价平仓
   - 限价平仓选项

2. 平仓Modal
   - 显示持仓详情
   - 选择平仓方式（市价/限价）
   - 选择平仓数量（部分/全部）
   - 预计盈亏显示
   - 确认平仓

3. 执行平仓
   - 调用position service
   - 构造平仓订单
   - 提交交易
   - 显示结果

4. 成功/失败处理
   - Toast提示
   - 更新持仓列表
   - 错误处理

5. 测试平仓
   - 测试市价平仓
   - 测试限价平仓
   - 测试部分平仓
   - 测试全部平仓

**交付物**:
- [ ] 平仓Modal组件
- [ ] 平仓执行逻辑

**验收标准**:
- 平仓功能正常
- 盈亏计算准确
- 错误处理完善

---

#### 任务18.3: 调整保证金功能 (2小时)

**详细步骤**:
1. 调整保证金按钮
   - 在持仓列表添加按钮

2. 调整保证金Modal
   - 显示当前保证金
   - 显示当前保证金率
   - 显示当前强平价
   - 输入增加/减少金额
   - 实时计算新保证金率
   - 实时计算新强平价
   - 显示风险变化

3. 执行调整
   - 调用position service
   - 提交交易
   - 显示结果

4. 验证规则
   - 增加保证金：不超过可用余额
   - 减少保证金：不低于维持保证金

5. 测试功能
   - 测试增加保证金
   - 测试减少保证金
   - 测试验证规则

**交付物**:
- [ ] 调整保证金Modal
- [ ] 调整执行逻辑

**验收标准**:
- 功能正常
- 计算准确
- 验证正确

---

#### 任务18.4: 止盈止损设置 (3小时)

**详细步骤**:
1. 止盈止损按钮
   - 在持仓列表添加按钮

2. 止盈止损Modal
   - 显示当前持仓信息
   - 止盈价格输入
   - 止损价格输入
   - 预期盈亏显示
   - 确认提交

3. 执行设置
   - 构造止盈止损订单
   - 提交交易

4. 显示止盈止损状态
   - 在持仓列表显示已设置的止盈止损
   - 显示触发价格
   - 支持修改和取消

5. 测试功能
   - 测试设置止盈
   - 测试设置止损
   - 测试修改
   - 测试取消

**交付物**:
- [ ] 止盈止损Modal
- [ ] 止盈止损逻辑

**验收标准**:
- 功能正常
- 触发准确
- UI清晰

---

#### 任务18.5: 持仓详情页面 (2小时)

**详细步骤**:
1. 创建详情页面
   - 创建 `src/app/positions/[id]/page.tsx`
   - 显示持仓完整信息

2. 详情内容
   - 基本信息：市场、方向、杠杆、数量
   - 价格信息：入场价、标记价、强平价
   - 盈亏信息：未实现盈亏、ROI、资金费用
   - 保证金信息：初始保证金、维持保证金、保证金率
   - 历史记录：开仓时间、加仓/减仓记录

3. 操作区域
   - 快速平仓按钮
   - 调整保证金按钮
   - 设置止盈止损按钮
   - 追加保证金按钮

4. 图表展示
   - 盈亏曲线图
   - 价格走势图
   - 标记强平价位

5. 测试页面
   - 测试信息显示
   - 测试操作功能

**交付物**:
- [ ] 持仓详情页面

**验收标准**:
- 信息完整准确
- 操作便捷
- UI美观

---

#### 任务18.6: 集成测试 (2小时)

**详细步骤**:
1. 完整流程测试
   - 开仓 → 查看持仓 → 平仓
   - 开仓 → 调整保证金 → 平仓
   - 开仓 → 设置止盈止损 → 等待触发/平仓

2. 实时更新测试
   - 测试盈亏实时更新
   - 测试强平价实时更新
   - 测试保证金率实时更新

3. 边界测试
   - 接近强平情况
   - 保证金不足
   - 极端价格波动

4. 修复Bug
   - 记录Bug
   - 修复
   - 回归测试

**交付物**:
- [ ] 测试报告
- [ ] Bug修复记录

**验收标准**:
- 核心流程正常
- 实时更新准确
- 无严重Bug

---

### Day 20-21: 期货订单管理与交易页面

**负责人**: 2名开发  
**工作时间**: 16小时

#### 任务20.1: 期货订单列表 (3小时)

**参考文件**: `injective-helix-demo/components/Partials/Trade/Orders/`

**详细步骤**:
1. FuturesOrders组件
   - 创建 `src/components/trading/FuturesOrders.tsx`
   - 复用现货订单列表结构
   - 调整为期货特有字段

2. 当前订单Tab
   - 显示未成交订单
   - 列：市场、方向、类型、价格、数量、已成交、杠杆、时间、操作
   - 取消订单按钮
   - 批量取消

3. 历史订单Tab
   - 显示已成交/已取消订单
   - 列：市场、方向、类型、价格、数量、状态、时间
   - 筛选：时间范围、市场、状态

4. 止盈止损订单Tab
   - 显示条件订单
   - 列：市场、方向、触发价、数量、状态
   - 取消/修改按钮

5. 实时更新
   - 订阅订单状态变化
   - 新订单自动加入列表
   - 成交订单自动移除

6. 测试组件
   - 测试订单显示
   - 测试取消订单
   - 测试实时更新

**交付物**:
- [ ] FuturesOrders组件
- [ ] 三个Tab页面
- [ ] 取消订单功能

**验收标准**:
- 订单信息完整
- 实时更新正常
- 取消功能正常

---

#### 任务20.2: 期货交易页面布局 (4小时)

**参考文件**: `injective-helix-demo/pages/futures.vue`

**详细步骤**:
1. 创建期货交易页面
   - 创建 `src/app/futures/[slug]/page.tsx`
   - 动态路由获取市场slug

2. 页面布局设计（桌面端）
   - 顶部：市场信息栏（MarketTicker）
   - 左侧：TradingView图表（占大部分空间）
   - 右上：订单簿 + 成交记录
   - 右中：下单表单
   - 底部：标签页（当前订单、持仓、订单历史）

3. 响应式布局
   - 平板：调整组件大小比例
   - 手机：堆叠布局，Tab切换各组件

4. 市场信息栏
   - 市场名称
   - 当前价格（大字显示）
   - 24h涨跌（颜色标识）
   - 24h高/低
   - 24h成交量
   - 标记价格
   - 指数价格
   - 资金费率
   - 下次结算时间
   - 市场切换下拉

5. 组件集成
   - 集成Orderbook组件
   - 集成TradesList组件
   - 集成FuturesOrderForm组件
   - 集成FuturesOrders组件
   - 集成PositionsList组件（简化版）

6. 状态管理
   - 使用derivativesStore
   - 页面加载时设置当前市场
   - 订阅市场数据
   - 页面卸载时取消订阅

7. 测试页面
   - 测试页面加载
   - 测试组件集成
   - 测试响应式布局
   - 测试市场切换

**交付物**:
- [ ] 期货交易页面
- [ ] 市场信息栏
- [ ] 完整布局

**验收标准**:
- 页面布局合理
- 所有组件正常工作
- 响应式布局正常
- 市场切换流畅

---

#### 任务20.3: 现货交易页面 (对比完善) (3小时)

**参考文件**: `injective-helix-demo/pages/spot.vue`

**详细步骤**:
1. 创建现货交易页面
   - 创建 `src/app/spot/[slug]/page.tsx`
   - 类似期货交易页面布局

2. 组件集成
   - 集成现货版本的Orderbook
   - 集成现货版本的TradesList
   - 集成SpotOrderForm
   - 集成现货版本的Orders列表

3. 市场信息栏
   - 现货特有信息
   - 无需显示杠杆、资金费率等

4. 测试页面
   - 测试页面功能
   - 测试与期货页面对比

**交付物**:
- [ ] 现货交易页面

**验收标准**:
- 页面功能完整
- 与期货页面风格一致

---

#### 任务20.4: TradingView图表集成（基础） (4小时)

**参考文件**: `injective-helix-demo/app/trading-view/`

**详细步骤**:
1. 获取TradingView库
   - 下载TradingView Charting Library
   - 或使用lightweight-charts作为替代

2. 创建TradingViewChart组件
   - 创建 `src/components/charts/TradingViewChart.tsx`
   - 初始化图表
   - 配置图表主题

3. 数据适配
   - 获取K线数据（OHLC）
   - 转换为TradingView格式
   - 加载历史数据

4. 实时更新
   - 订阅实时K线更新
   - 更新图表数据

5. 基础功能
   - 时间周期切换（1m, 5m, 15m, 1h, 4h, 1d）
   - 图表类型切换（蜡烛图、折线图）
   - 缩放和平移

6. 集成到交易页面
   - 替换占位区域
   - 调整大小适配

7. 测试图表
   - 测试数据加载
   - 测试实时更新
   - 测试交互功能

**注意**: 如果TradingView库授权问题，先使用lightweight-charts，Week 6再优化

**交付物**:
- [ ] TradingViewChart组件
- [ ] 数据适配逻辑
- [ ] 基础功能

**验收标准**:
- 图表可正常显示
- K线数据正确
- 实时更新正常
- 交互流畅

---

#### 任务20.5: Week 3集成测试 (2小时)

**详细步骤**:
1. 完整流程测试
   - 测试现货交易完整流程
   - 测试期货交易完整流程
   - 测试持仓管理流程

2. 页面测试
   - 测试现货交易页面
   - 测试期货交易页面
   - 测试页面切换

3. 数据一致性测试
   - 测试订单簿数据
   - 测试持仓数据
   - 测试订单数据

4. 性能测试
   - 测试页面加载速度
   - 测试实时更新性能
   - 测试大量数据处理

5. Bug修复
   - 记录所有Bug
   - 按优先级修复
   - 回归测试

**交付物**:
- [ ] 测试报告
- [ ] Bug列表和修复记录

**验收标准**:
- Week 3所有功能正常
- 现货和期货交易都可用
- 无严重Bug
- 性能良好

---

### Week 3 验收标准

#### 功能验收
- [ ] 可以开仓做多
- [ ] 可以开仓做空
- [ ] 可以选择杠杆（1x-20x）
- [ ] 强平价计算准确
- [ ] 保证金计算准确
- [ ] 持仓列表正确显示
- [ ] 未实现盈亏实时更新
- [ ] 可以市价平仓
- [ ] 可以限价平仓
- [ ] 可以调整保证金
- [ ] 可以设置止盈止损
- [ ] 期货订单列表显示正确
- [ ] 现货交易页面完整
- [ ] 期货交易页面完整
- [ ] TradingView图表基本可用

#### 性能验收
- [ ] 交易页面加载 < 2s
- [ ] 实时更新流畅无卡顿
- [ ] 图表交互流畅

#### 质量验收
- [ ] 无TypeScript错误
- [ ] 无ESLint错误
- [ ] 计算精度准确
- [ ] 无严重Bug

#### UI验收
- [ ] 交易页面布局合理
- [ ] 响应式布局正常
- [ ] 与Nuxt版本风格一致

---


---

**涓婁竴鍛?*: [Week 2](./week-02.md) | **涓嬩竴鍛?*: [Week 4](./week-04.md)
