<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机构KYB认证 - 用户端原型</title>
    <!-- TailwindCSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Alpine.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; } /* 避免Alpine初始化闪烁 */
    </style>
</head>
<body class="bg-gray-50 text-gray-900" x-data="kybUserApp()">

    <!-- 顶部导航 -->
    <header class="bg-white shadow sticky top-0 z-10">
        <div class="max-w-3xl mx-auto px-4 py-4 flex items-center justify-between">
            <h1 class="text-2xl font-bold tracking-tight">机构认证 (用户)</h1>
            <!-- 用户端导航只显示相关链接 -->
            <div class="flex space-x-2">
                <button class="px-3 py-1 rounded hover:bg-gray-100" :class="{ 'font-bold text-blue-600': page==='home' }" @click="page='home'">首页</button>
                <!-- 后台链接在用户端移除 -->
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-8">
        
        <!-- 进度条 -->
        <div x-show="page !== 'home'" class="mb-8">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">KYB认证进度</span>
                    <span class="text-sm text-gray-500" x-text="getProgressText()"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" :style="`width: ${getProgressPercentage()}%`"></div>
                </div>
                <div class="flex justify-between mt-2 text-xs text-gray-500">
                    <span>基本信息</span>
                    <span>材料清单</span>
                    <span>上传材料</span>
                </div>
            </div>
        </div>

        <!-- 认证首页 -->
        <section x-show="page==='home'" x-transition x-cloak>
            <div class="flex flex-col items-center">
                <img src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80" alt="认证" class="rounded-xl w-64 h-40 object-cover mb-6 shadow">
                <h2 class="text-xl font-semibold mb-2">欢迎进行机构KYB认证</h2>
                <p class="mb-4 text-gray-600">为保障平台合规与安全，请完成机构KYB认证流程。认证后可正常使用全部服务。</p>
                <div class="w-full max-w-md">
                    <div class="mb-4">
                        <div class="flex items-center mb-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span>
                            <span>1. 填写机构基本信息</span>
                        </div>
                        <div class="flex items-center mb-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span>
                            <span>2. 查看材料清单</span>
                        </div>
                        <div class="flex items-center mb-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span>
                            <span>3. 上传认证材料</span>
                        </div>
                        <div class="flex items-center mb-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span>
                            <span>4. 提交审核</span>
                        </div>
                    </div>
                    <button class="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition" @click="page='country'">开始认证</button>
                </div>
            </div>
        </section>

        <!-- 国家选择页 (优化版) -->
        <section x-show="page==='country'" x-transition x-cloak>
            <div class="max-w-md mx-auto bg-white rounded-xl shadow p-8">
                <h2 class="text-lg font-bold mb-4">选择机构注册国家/地区</h2>
                
                <!-- 公司名称字段 -->
                <div class="mb-4">
                    <label class="block mb-1 font-medium text-gray-700">公司名称 <span class="text-red-500">*</span></label>
                    <input
                        type="text"
                        class="w-full border rounded p-2"
                        placeholder="请输入公司名称"
                        x-model="form.companyName"
                        :class="{'border-red-500': companyNameError}"
                    >
                    <div x-show="companyNameError" class="text-red-600 text-sm mt-1" x-text="companyNameError"></div>
                </div>

                <!-- 注册号字段 -->
                <div class="mb-4">
                    <label class="block mb-1 font-medium text-gray-700">注册号 <span class="text-red-500">*</span></label>
                    <input
                        type="text"
                        class="w-full border rounded p-2"
                        placeholder="请输入注册号/统一社会信用代码"
                        x-model="form.registrationNumber"
                        :class="{'border-red-500': registrationNumberError}"
                    >
                    <div x-show="registrationNumberError" class="text-red-600 text-sm mt-1" x-text="registrationNumberError"></div>
                </div>

                <!-- 国家搜索和选择区域 -->
                <div class="relative mb-4">
                    <label class="block mb-1 font-medium text-gray-700">注册国家/地区 <span class="text-red-500">*</span></label>
                    <input
                        type="text"
                        class="w-full border rounded p-2"
                        placeholder="搜索国家或地区..."
                        x-model="countrySearchText"
                        @click.outside="showCountryDropdown = false"
                        @focus="showCountryDropdown = true"
                        @input="showCountryDropdown = true"
                        :class="{'border-red-500': countryError}"
                    >
                    <!-- 显示当前选中的国家 -->
                    <div x-show="selectedCountryName" class="absolute top-0 right-2 mt-3 text-gray-600 text-sm" x-text="selectedCountryName"></div>

                    <!-- 国家列表下拉框 -->
                    <ul x-show="showCountryDropdown && filteredCountries.length > 0" class="absolute z-10 w-full bg-white border rounded shadow-lg mt-1 max-h-48 overflow-y-auto">
                        <template x-for="country in filteredCountries" :key="country.code">
                            <li
                                class="px-4 py-2 hover:bg-blue-100 cursor-pointer"
                                @click="selectCountry(country)"
                                x-text="`${country.name} (${country.code})`"
                            ></li>
                        </template>
                    </ul>
                    <div x-show="countryError" class="text-red-600 text-sm mt-1" x-text="countryError"></div>
                </div>

                <div class="flex space-x-2">
                    <button class="flex-1 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" @click="page='home'">返回上一步</button>
                    <button class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" @click="checkCountryAndNext">下一步</button>
                </div>
            </div>
        </section>

        <!-- 材料清单预览页 -->
        <section x-show="page==='materials'" x-transition x-cloak>
            <div class="max-w-2xl mx-auto bg-white rounded-xl shadow p-8">
                <h2 class="text-lg font-bold mb-4">需要准备的KYB认证材料 (<span x-text="selectedCountryName"></span>)</h2>
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                    <div class="flex">
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>温馨提示：</strong>请提前准备好以下所有机构认证材料的电子版本（PDF、JPG、PNG格式，单个文件不超过10MB），我们将逐一引导您上传。
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <template x-for="(item, index) in materialList(form.country)" :key="item">
                        <div class="flex items-start p-4 border rounded-lg">
                            <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-sm font-semibold text-blue-600" x-text="index + 1"></span>
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-medium text-gray-900" x-text="item"></h3>
                                <p class="text-sm text-gray-600 mt-1" x-text="getMaterialDescription(item)"></p>
                            </div>
                            <div class="flex-shrink-0">
                                <div x-show="form.files[item]" class="text-green-600">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div class="flex space-x-2 mt-6">
                    <button class="flex-1 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" @click="page='country'">返回上一步</button>
                    <button class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" @click="startFileUpload">开始上传</button>
                </div>
            </div>
        </section>

        <!-- 单个文件上传页 -->
        <section x-show="page==='upload'" x-transition x-cloak>
            <div class="max-w-md mx-auto bg-white rounded-xl shadow p-8">
                <div class="text-center mb-6">
                    <div class="text-sm text-gray-500 mb-2">
                        第 <span x-text="currentUploadIndex + 1"></span> 步，共 <span x-text="materialList(form.country).length"></span> 步
                    </div>
                    <h2 class="text-lg font-bold" x-text="getCurrentMaterial()"></h2>
                    <p class="text-sm text-gray-600 mt-2" x-text="getMaterialDescription(getCurrentMaterial())"></p>
                </div>

                <div class="mb-6">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center" 
                         :class="{'border-blue-500 bg-blue-50': isDragOver, 'border-green-500 bg-green-50': form.files[getCurrentMaterial()]}"
                         @dragover.prevent="isDragOver = true"
                         @dragleave.prevent="isDragOver = false"
                         @drop.prevent="handleFileDrop($event)">
                        
                        <template x-if="!form.files[getCurrentMaterial()]">
                            <div>
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <div class="mt-4">
                                    <label class="cursor-pointer">
                                        <span class="mt-2 block text-sm font-medium text-gray-900">点击上传文件</span>
                                        <span class="mt-1 block text-xs text-gray-500">或拖拽文件到此处</span>
                                        <span class="mt-1 block text-xs text-gray-500">支持 PDF、JPG、PNG 格式，最大 10MB</span>
                                        <input type="file" accept=".pdf,.jpg,.jpeg,.png" class="sr-only" @change="handleFileUpload($event)">
                                    </label>
                                </div>
                            </div>
                        </template>

                        <template x-if="form.files[getCurrentMaterial()]">
                            <div>
                                <svg class="mx-auto h-12 w-12 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                <div class="mt-4">
                                    <p class="text-sm font-medium text-green-600">文件上传成功</p>
                                    <p class="text-xs text-gray-500 mt-1" x-text="form.files[getCurrentMaterial()]?.name"></p>
                                    <button class="mt-2 text-xs text-blue-600 hover:text-blue-800" @click="removeCurrentFile()">重新上传</button>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <div x-show="form.fileErrors[getCurrentMaterial()]" class="text-red-600 text-sm mt-2" x-text="form.fileErrors[getCurrentMaterial()]"></div>
                </div>

                <div class="flex space-x-2">
                    <button class="flex-1 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" @click="goToPreviousStep()">上一步</button>
                    <button class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" 
                            :disabled="!form.files[getCurrentMaterial()]"
                            :class="{'opacity-50 cursor-not-allowed': !form.files[getCurrentMaterial()]}"
                            @click="goToNextStep()">
                        <span x-text="isLastUploadStep() ? '完成上传' : '下一步'"></span>
                    </button>
                </div>
            </div>
        </section>





        <!-- 后台管理相关Section在此处移除 -->

    </main>

    <script>
        function kybUserApp() { // Alpine data 函数名称为 kybUserApp
            return {
                page: 'home', // 当前显示的页面 (home, country, materials, upload)
                currentUploadIndex: 0, // 当前上传的文件索引
                isDragOver: false, // 拖拽状态
                form: { // 用户填写的表单数据和上传文件状态
                    country: '', // 存储国家代码，例如 'CN'
                    companyName: '', // 公司名称
                    registrationNumber: '', // 注册号
                    files: {}, // { '材料名称': File 对象 } - 实际上传的文件对象
                    fileErrors: {} // { '材料名称': '错误信息' }
                },
                uploadErrorItems: [], // 材料上传页未上传项列表，用于标红
                countrySearchText: '', // 国家搜索框文本
                showCountryDropdown: false, // 控制国家下拉列表显示隐藏
                selectedCountryName: '', // 显示在输入框旁边的国家名称
                countryError: '', // 国家选择错误提示
                companyNameError: '', // 公司名称错误提示
                registrationNumberError: '', // 注册号错误提示

                // 国家/地区列表 (新增数据，包含国家代码)
                countries: [
                    { code: 'CN', name: '中国大陆' },
                    { code: 'HK', name: '香港' },
                    { code: 'US', name: '美国' },
                    { code: 'GB', name: '英国' },
                    { code: 'SG', name: '新加坡' },
                    { code: 'JP', name: '日本' },
                    { code: 'DE', name: '德国' },
                    { code: 'FR', name: '法国' },
                    { code: 'CA', name: '加拿大' },
                    { code: 'AU', name: '澳大利亚' },
                    // 可以继续添加更多国家
                ],



                // 根据搜索文本过滤国家列表 (计算属性)
                get filteredCountries() {
                    // 如果搜索文本为空，并且已经选择了国家，只显示选中的国家（避免列表闪烁）
                    if (!this.countrySearchText && this.form.country && this.selectedCountryName) {
                        // 根据已选的国家代码找到对应的国家对象
                        const selectedCountry = this.countries.find(c => c.code === this.form.country);
                        return selectedCountry ? [selectedCountry] : [];
                    }
                    // 如果搜索文本为空，显示全部国家
                    if (!this.countrySearchText) {
                        return this.countries;
                    }
                    // 过滤逻辑：名称或代码包含搜索文本
                    const lowerSearchText = this.countrySearchText.toLowerCase();
                    return this.countries.filter(country =>
                        country.name.toLowerCase().includes(lowerSearchText) ||
                        country.code.toLowerCase().includes(lowerSearchText)
                    );
                },

                // 选择国家
                selectCountry(country) {
                    this.form.country = country.code; // 存储国家代码
                    this.selectedCountryName = country.name; // 显示国家名称
                    this.countrySearchText = country.name; // 将选择的名称放入搜索框，模拟已填写
                    this.showCountryDropdown = false; // 隐藏下拉列表
                    this.countryError = ''; // 清除错误提示
                    console.log('Selected country:', this.form.country);
                },

                // 检查是否选择了国家并跳转到材料上传页
                checkCountryAndNext() {
                    let hasError = false;

                    // 验证公司名称
                    if (!this.form.companyName || this.form.companyName.trim() === '') {
                        this.companyNameError = '请输入公司名称';
                        hasError = true;
                    } else {
                        this.companyNameError = '';
                    }

                    // 验证注册号
                    if (!this.form.registrationNumber || this.form.registrationNumber.trim() === '') {
                        this.registrationNumberError = '请输入注册号';
                        hasError = true;
                    } else {
                        this.registrationNumberError = '';
                    }

                    // 验证国家选择
                    if (!this.form.country) {
                        this.countryError = '请选择机构注册国家/地区';
                        hasError = true;
                    } else {
                        this.countryError = '';
                    }

                    // 如果有任何验证错误，阻止跳转
                    if (hasError) {
                        return;
                    }

                    // 重置文件上传状态，避免影响新国家
                    this.form.files = {};
                    this.form.fileErrors = {};
                    this.uploadErrorItems = [];

                    this.page = 'materials'; // 跳转到材料清单页
                },

                // 获取当前国家所需材料列表 (使用国家代码查找)
                materialList(countryCode) {
                    // 实际应根据 countryCode 获取对应的材料列表 from backend/Sumsub
                    // 目前沿用之前的逻辑，需要根据 Sumsub 的材料清单进行调整和补充
                    const base = [
                        '机构营业执照/注册证明',
                        '法定代表人身份证明',
                        '机构章程或组织结构文件'
                    ];
                    const extra = {
                        'CN': ['营业执照副本', '组织机构代码证', '税务登记证（如三证未合一）'],
                        'HK': ['商业登记证', '公司注册证书', '董事身份证明'],
                        'US': ['EIN证明', '公司章程', '公司成立证明（Articles of Incorporation）'],
                        'GB': ['公司注册证书（Certificate of Incorporation）', '公司章程（Articles of Association）', '董事身份证明'],
                        'SG': ['ACRA注册文件', '董事身份证明'],
                        'JP': ['登记簿誊本', '法人印章证明', '董事身份证明'],
                        'DE': ['Handelsregisterauszug', 'Gesellschafterliste'], // 德国示例
                        'FR': ['Extrait Kbis'], // 法国示例
                        'CA': ['Articles of Incorporation', 'Federal Business Number'], // 加拿大示例
                        'AU': ['Certificate of Registration of a Company', 'Company Extract'], // 澳大利亚示例
                    };
                    // 找到国家代码对应的材料列表，否则使用基础列表
                    // 使用 find 方法查找，确保即使extra[countryCode]不存在也不会报错
                    const specificMaterials = extra[countryCode] || [];
                    // 移除 base 中与 specificMaterials 重复的材料，再合并
                    const uniqueBase = base.filter(item => !specificMaterials.includes(item));

                    return uniqueBase.concat(specificMaterials);
                },

                // 获取材料描述信息
                getMaterialDescription(material) {
                    const descriptions = {
                        '机构营业执照/注册证明': '请上传清晰的营业执照或公司注册证明文件',
                        '法定代表人身份证明': '请上传法定代表人的身份证或护照等有效证件',
                        '机构章程或组织结构文件': '请上传公司章程或组织架构相关文件',
                        '营业执照副本': '请上传营业执照副本的清晰扫描件',
                        '组织机构代码证': '请上传组织机构代码证',
                        '税务登记证（如三证未合一）': '如未进行三证合一，请上传税务登记证',
                        '商业登记证': '请上传香港商业登记证',
                        '公司注册证书': '请上传公司注册证书',
                        '董事身份证明': '请上传董事的身份证明文件',
                        'EIN证明': '请上传美国雇主识别号(EIN)证明',
                        '公司章程': '请上传公司章程文件',
                        '公司成立证明（Articles of Incorporation）': '请上传公司成立证明文件',
                        'ACRA注册文件': '请上传新加坡ACRA注册相关文件',
                        '登记簿誊本': '请上传日本登记簿誊本',
                        '法人印章证明': '请上传法人印章证明'
                    };
                    return descriptions[material] || '请上传相关证明文件';
                },

                // 开始文件上传流程
                startFileUpload() {
                    this.currentUploadIndex = 0;
                    this.page = 'upload';
                },

                // 获取当前需要上传的材料
                getCurrentMaterial() {
                    const materials = this.materialList(this.form.country);
                    return materials[this.currentUploadIndex] || '';
                },

                // 判断是否是最后一个上传步骤
                isLastUploadStep() {
                    return this.currentUploadIndex >= this.materialList(this.form.country).length - 1;
                },

                // 处理文件上传
                handleFileUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    this.processFile(file);
                },

                // 处理拖拽上传
                handleFileDrop(e) {
                    this.isDragOver = false;
                    const file = e.dataTransfer.files[0];
                    if (!file) return;
                    this.processFile(file);
                },

                // 处理文件（统一的文件处理逻辑）
                processFile(file) {
                    const currentMaterial = this.getCurrentMaterial();
                    
                    // 校验类型和大小
                    const validTypes = ['application/pdf', 'image/jpeg', 'image/png'];
                    if (!validTypes.includes(file.type)) {
                        this.form.fileErrors[currentMaterial] = '仅支持PDF/JPG/PNG格式';
                        return;
                    }
                    if (file.size > 10 * 1024 * 1024) {
                        this.form.fileErrors[currentMaterial] = '单文件最大10MB';
                        return;
                    }

                    this.form.fileErrors[currentMaterial] = ''; // 清除错误
                    this.form.files[currentMaterial] = file; // 存储文件对象

                    console.log(`文件上传成功: ${file.name} for ${currentMaterial}`);
                },

                // 移除当前文件
                removeCurrentFile() {
                    const currentMaterial = this.getCurrentMaterial();
                    delete this.form.files[currentMaterial];
                    delete this.form.fileErrors[currentMaterial];
                },

                // 上一步
                goToPreviousStep() {
                    if (this.currentUploadIndex > 0) {
                        this.currentUploadIndex--;
                    } else {
                        this.page = 'materials';
                    }
                },

                // 下一步
                goToNextStep() {
                    if (this.isLastUploadStep()) {
                        // 完成所有文件上传，直接提交
                        this.submitKyb();
                    } else {
                        this.currentUploadIndex++;
                    }
                },

                // 获取进度百分比
                getProgressPercentage() {
                    if (this.page === 'country') return 25;
                    if (this.page === 'materials') return 50;
                    if (this.page === 'upload') {
                        const totalSteps = this.materialList(this.form.country).length;
                        const currentProgress = 50 + (this.currentUploadIndex / totalSteps) * 50;
                        return Math.round(currentProgress);
                    }
                    return 0;
                },

                // 获取进度文本
                getProgressText() {
                    if (this.page === 'country') return '第1步：填写机构基本信息';
                    if (this.page === 'materials') return '第2步：查看材料清单';
                    if (this.page === 'upload') {
                        const current = this.currentUploadIndex + 1;
                        const total = this.materialList(this.form.country).length;
                        return `第3步：上传认证材料 (${current}/${total})`;
                    }
                    return '';
                },





                // 提交KYB认证
                submitKyb() {
                    // >>>>>> TODO: 实际对接后台API提交KYB认证 <<<<<<
                    // 1. 收集基本信息：公司名称、注册号、国家代码
                    // 2. 收集 form.files 中已上传的文件对象 (实际文件)
                    // 3. 调用后台API提交（需处理文件上传、信息传输等）
                    console.log('KYB认证 - 提交基本信息:', {
                        companyName: this.form.companyName,
                        registrationNumber: this.form.registrationNumber,
                        country: this.form.country
                    });
                    console.log('KYB认证 - 提交认证文件:', this.form.files);

                    // 显示成功提示弹窗
                    alert('KYB认证提交成功！\n\n您的机构认证材料已成功提交，我们将在1-3个工作日内完成审核。\n审核结果将通过邮件或短信通知您。');
                    
                    // 返回首页
                    this.page = 'home';
                    
                    // 重置表单数据
                    this.form = {
                        country: '',
                        companyName: '',
                        registrationNumber: '',
                        files: {},
                        fileErrors: {}
                    };
                    this.currentUploadIndex = 0;
                    this.selectedCountryName = '';
                    this.countrySearchText = '';
                },






            }
        }

        // 用户端应用启动
        document.addEventListener('alpine:init', () => {
            Alpine.data('kybUserApp', kybUserApp);
        });
    </script>
</body>
</html>