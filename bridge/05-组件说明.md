# 05 - ç»„ä»¶è¯´æ˜

> **é€‚åˆäººç¾¤**: å¼€å‘è€…  
> **é˜…è¯»æ—¶é—´**: 30 åˆ†é’Ÿ  
> **ä»£ç å‚è€ƒ**: `/lib/bridge`, `/context/bridge`, `/components/bridge`

---

## ğŸ“– ç›®å½•

1. [Context Providers](#context-providers)
2. [æ ¸å¿ƒæœåŠ¡](#æ ¸å¿ƒæœåŠ¡)
3. [æ™ºèƒ½åˆçº¦](#æ™ºèƒ½åˆçº¦)
4. [UI ç»„ä»¶](#ui-ç»„ä»¶)
5. [å·¥å…·å‡½æ•°](#å·¥å…·å‡½æ•°)

---

## ğŸ”„ Context Providers

### 1. BridgeProvidersï¼ˆæ ¹å®¹å™¨ï¼‰

**æ–‡ä»¶**: `context/bridge/BridgeProviders.tsx`

```typescript
export function BridgeProviders({ children }: BridgeProvidersProps) {
  return (
    <WagmiProvider config={config}>
      <QueryClientProvider client={queryClient}>
        <WalletProvider>
          <AccountProvider>
            <TokenProvider>
              <PeggyProvider>
                <AxelarProvider>
                  <EventProvider>
                    {children}
                  </EventProvider>
                </AxelarProvider>
              </PeggyProvider>
            </TokenProvider>
          </AccountProvider>
        </WalletProvider>
      </QueryClientProvider>
    </WagmiProvider>
  )
}
```

**èŒè´£**ï¼šèšåˆæ‰€æœ‰ Bridge ç›¸å…³çš„ Context

**ä½¿ç”¨æ–¹å¼**ï¼š
```typescript
import { BridgeProviders } from '@/context/bridge/BridgeProviders'

<BridgeProviders>
  <YourBridgeComponent />
</BridgeProviders>
```

---

### 2. WalletProviderï¼ˆé’±åŒ…ç®¡ç†ï¼‰

**æ–‡ä»¶**: `context/bridge/WalletProvider.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- è¿æ¥/æ–­å¼€é’±åŒ…
- ç®¡ç†é’±åŒ…çŠ¶æ€
- æä¾›é’±åŒ…åœ°å€

**å¯¼å‡ºçš„ Hook**ï¼š
```typescript
const {
  address,              // ä»¥å¤ªåŠ/BSC åœ°å€
  injectiveAddress,     // Injective åœ°å€
  wallet,               // å½“å‰è¿æ¥çš„é’±åŒ…
  connect,              // è¿æ¥é’±åŒ…
  disconnect            // æ–­å¼€é’±åŒ…
} = useWallet()
```

**è¿æ¥é’±åŒ…ç¤ºä¾‹**ï¼š
```typescript
// è¿æ¥ Keplrï¼ˆInjectiveï¼‰
await connect(Wallet.Keplr)

// è¿æ¥ MetaMaskï¼ˆEthereumï¼‰
await connect(Wallet.MetaMask)
```

**å†…éƒ¨å®ç°**ï¼š
- ä½¿ç”¨ `WalletStrategy` ç»Ÿä¸€ç®¡ç†å¤šç§é’±åŒ…
- ç›‘å¬é’±åŒ…è´¦æˆ·å˜åŒ–
- è‡ªåŠ¨ä¿å­˜è¿æ¥çŠ¶æ€

---

### 3. AccountProviderï¼ˆä½™é¢ç®¡ç†ï¼‰

**æ–‡ä»¶**: `context/bridge/AccountProvider.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- æŸ¥è¯¢ä½™é¢
- æŸ¥è¯¢æˆæƒé¢åº¦
- ç¼“å­˜ä½™é¢æ•°æ®

**å¯¼å‡ºçš„ Hook**ï¼š
```typescript
const {
  denomBalanceMap,         // Injective ä½™é¢
  bnbDenomBalanceMap,      // BSC ä½™é¢
  fetchBalanceAndAllowance, // åˆ·æ–°ä½™é¢
  isLoading                // åŠ è½½çŠ¶æ€
} = useAccount()
```

**ä½™é¢ç»“æ„**ï¼š
```typescript
denomBalanceMap = {
  "peggy0xdAC17F958D2ee523a2206206994597C13D831ec7": {
    balance: "100000000",    // åŸå§‹å€¼ï¼ˆæœ€å°å•ä½ï¼‰
    inUsd: "100.00",         // USD ä»·å€¼
    denom: "peggy0xdAC17F958D2ee523a2206206994597C13D831ec7"
  }
}
```

**æŸ¥è¯¢ä½™é¢ç¤ºä¾‹**ï¼š
```typescript
// è‡ªåŠ¨æŸ¥è¯¢ï¼ˆè¿æ¥é’±åŒ…åï¼‰
useEffect(() => {
  if (address && injectiveAddress) {
    fetchBalanceAndAllowance()
  }
}, [address, injectiveAddress])

// æ‰‹åŠ¨åˆ·æ–°
const handleRefresh = () => {
  fetchBalanceAndAllowance()
}
```

---

### 4. TokenProviderï¼ˆä»£å¸ä»·æ ¼ï¼‰

**æ–‡ä»¶**: `context/bridge/TokenProvider.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- è·å–ä»£å¸å®æ—¶ä»·æ ¼
- ç¼“å­˜ä»·æ ¼æ•°æ®
- è®¡ç®— USD ä»·å€¼

**å¯¼å‡ºçš„ Hook**ï¼š
```typescript
const {
  tokens,           // æ‰€æœ‰ä»£å¸åˆ—è¡¨
  tokenPrice        // ä»·æ ¼æ˜ å°„
} = useToken()
```

**ä»·æ ¼ç»“æ„**ï¼š
```typescript
tokenPrice = {
  "inj": {
    price: 20.5,
    change24h: 5.2
  },
  "usdt": {
    price: 1.0,
    change24h: 0.01
  }
}
```

---

### 5. PeggyProviderï¼ˆPeggy æ¡¥æ¥ï¼‰

**æ–‡ä»¶**: `context/bridge/PeggyProvider.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- Peggy å­˜æ¬¾ï¼ˆETH â†’ INJï¼‰
- Peggy æç°ï¼ˆINJ â†’ ETHï¼‰
- äº¤æ˜“çŠ¶æ€ç®¡ç†

**å¯¼å‡ºçš„ Hook**ï¼š
```typescript
const {
  peggyEthDeposit,      // å­˜æ¬¾åˆ° Injective
  peggyInjectiveToEth   // æç°åˆ°ä»¥å¤ªåŠ
} = usePeggy()
```

**Peggy å­˜æ¬¾ç¤ºä¾‹**ï¼š
```typescript
const handleDeposit = async () => {
  try {
    const txHash = await peggyEthDeposit({
      amount: "100",
      token: ethUsdtToken
    })
    
    console.log('Transaction hash:', txHash)
    // æ˜¾ç¤ºæˆåŠŸæç¤º
  } catch (error) {
    console.error('Deposit failed:', error)
    // æ˜¾ç¤ºé”™è¯¯æç¤º
  }
}
```

**Peggy æç°ç¤ºä¾‹**ï¼š
```typescript
const handleWithdraw = async () => {
  const txHash = await peggyInjectiveToEth({
    amount: "50",
    token: injUsdtToken
  })
  
  console.log('Withdraw initiated:', txHash)
}
```

---

### 6. AxelarProviderï¼ˆAxelar æ¡¥æ¥ï¼‰

**æ–‡ä»¶**: `context/bridge/AxelarProvider.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- Axelar å¤šé“¾æ¡¥æ¥
- è·¯ç”±è®¡ç®—
- è·¨é“¾äº¤æ˜“

**å¯¼å‡ºçš„ Hook**ï¼š
```typescript
const {
  axelarEvmDeposit,         // EVMé“¾ â†’ Injective
  axelarInjectiveDeposit    // Injective â†’ EVMé“¾
} = useAxelar()
```

**Axelar æ¡¥æ¥ç¤ºä¾‹**ï¼š
```typescript
const handleAxelarBridge = async () => {
  const txHash = await axelarEvmDeposit({
    amount: "100",
    fromToken: bnbUsdtToken,   // BSC USDT
    toToken: injAxlUsdcToken   // INJ axlUSDC
  })
}
```

---

### 7. EventProviderï¼ˆäº‹ä»¶å¤„ç†ï¼‰

**æ–‡ä»¶**: `context/bridge/EventProvider.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- æä¾›å…¨å±€å›è°ƒ
- å¤„ç†æˆåŠŸ/å¤±è´¥äº‹ä»¶

**å¯¼å‡ºçš„ Hook**ï¼š
```typescript
const {
  onSuccess,   // æˆåŠŸå›è°ƒ
  onError,     // å¤±è´¥å›è°ƒ
  onInit       // åˆå§‹åŒ–å›è°ƒ
} = useEvent()
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
<EventProvider
  onSuccess={() => {
    toast.success('Bridge successful!')
    refreshBalances()
  }}
  onError={(error) => {
    toast.error(`Bridge failed: ${error.message}`)
  }}
>
  <BridgeUI />
</EventProvider>
```

---

## ğŸ”§ æ ¸å¿ƒæœåŠ¡

### 1. web3Clientï¼ˆWeb3 å®¢æˆ·ç«¯ï¼‰

**æ–‡ä»¶**: `lib/bridge/services/web3Client.ts`

**èŒè´£**ï¼š
- å‡†å¤‡äº¤æ˜“
- å¹¿æ’­äº¤æ˜“
- æŸ¥è¯¢ä½™é¢

**ä¸»è¦æ–¹æ³•**ï¼š
```typescript
class Web3Client {
  // æŸ¥è¯¢ä½™é¢
  async fetchBalance(
    address: string,
    tokenAddress: string
  ): Promise<string>
  
  // å‡†å¤‡ Peggy å­˜æ¬¾äº¤æ˜“
  async preparePeggyDepositTransaction(
    token: TokenStatic,
    amount: string,
    injectiveAddress: string
  ): Promise<TransactionData>
  
  // å¹¿æ’­äº¤æ˜“
  async broadcastTransaction(
    txData: TransactionData
  ): Promise<string>
}
```

---

### 2. web3Composerï¼ˆäº¤æ˜“ç»„è£…å™¨ï¼‰

**æ–‡ä»¶**: `lib/bridge/services/web3composer.ts`

**èŒè´£**ï¼š
- ç»„è£… Peggy äº¤æ˜“
- è®¡ç®— Gas
- æ„å»ºäº¤æ˜“å‚æ•°

**ä¸»è¦æ–¹æ³•**ï¼š
```typescript
class Web3Composer {
  // Peggy å­˜æ¬¾æ¶ˆæ¯
  getPeggyDepositMsg({
    amount,
    address,
    denom,
    injectiveAddress
  }): MsgSendToEth
  
  // Peggy æç°æ¶ˆæ¯
  getPeggyWithdrawMsg({
    amount,
    address,
    denom,
    injectiveAddress,
    bridgeFee
  }): MsgSendToEth
}
```

---

### 3. walletServiceï¼ˆé’±åŒ…æœåŠ¡ï¼‰

**æ–‡ä»¶**: `lib/bridge/wallet/walletService.ts`

**èŒè´£**ï¼š
- å¹¿æ’­ Cosmos äº¤æ˜“
- å¹¿æ’­ EVM äº¤æ˜“
- ç®¡ç†ç­¾å

**ä¸»è¦æ–¹æ³•**ï¼š
```typescript
// å¹¿æ’­ Injective äº¤æ˜“
export const msgBroadcaster = new MsgBroadcaster({
  walletStrategy: walletStrategy,
  network: NETWORK
})

// å¹¿æ’­ Web3 äº¤æ˜“
export const web3Broadcaster = new Web3Broadcaster({
  network: NETWORK,
  ethereumChainId: ETHEREUM_CHAIN_ID
})
```

---

## ğŸ“œ æ™ºèƒ½åˆçº¦

### 1. BaseContractï¼ˆåˆçº¦åŸºç±»ï¼‰

**æ–‡ä»¶**: `lib/bridge/contracts/BaseContract.ts`

**èŒè´£**ï¼š
- åˆçº¦å®ä¾‹åŒ–
- ABI è§£æ
- é€šç”¨æ–¹æ³•

```typescript
export class BaseContract {
  constructor(
    contractAddress: string,
    abi: any
  ) {
    this.address = contractAddress
    this.ethersInterface = new ethers.utils.Interface(abi)
  }
  
  // ç¼–ç å‡½æ•°è°ƒç”¨
  encodeFunctionData(
    functionName: string,
    args: any[]
  ): string
}
```

---

### 2. Erc20Contractï¼ˆERC20 åˆçº¦ï¼‰

**æ–‡ä»¶**: `lib/bridge/contracts/Erc20Contract.ts`

**èŒè´£**ï¼š
- æŸ¥è¯¢ä½™é¢
- æŸ¥è¯¢æˆæƒ
- æˆæƒæ“ä½œ

```typescript
export class Erc20Contract extends BaseContract {
  // æŸ¥è¯¢ä½™é¢
  async balanceOf(address: string): Promise<BigNumber>
  
  // æŸ¥è¯¢æˆæƒé¢åº¦
  async allowance(
    owner: string,
    spender: string
  ): Promise<BigNumber>
  
  // æˆæƒ
  async approve(
    spender: string,
    amount: BigNumber
  ): Promise<TransactionResponse>
}
```

---

### 3. PeggyContractï¼ˆPeggy åˆçº¦ï¼‰

**æ–‡ä»¶**: `lib/bridge/contracts/Peggy.ts`

**èŒè´£**ï¼š
- Peggy å­˜æ¬¾
- ç›‘å¬äº‹ä»¶

```typescript
export class PeggyContract extends BaseContract {
  // å‘é€åˆ° Injective
  async sendToInjective(
    tokenAddress: string,
    destination: string,
    amount: BigNumber
  ): Promise<TransactionResponse>
}
```

---

## ğŸ¨ UI ç»„ä»¶

### 1. BridgeFromV2ï¼ˆä¸»è¡¨å•ï¼‰

**æ–‡ä»¶**: `components/bridge/BridgeFromV2.tsx`

**èŒè´£**ï¼š
- æ¸²æŸ“æ¡¥æ¥è¡¨å•
- å¤„ç†ç”¨æˆ·è¾“å…¥
- è°ƒç”¨æ¡¥æ¥é€»è¾‘

**å…³é”®åŠŸèƒ½**ï¼š
```typescript
// ç½‘ç»œé€‰æ‹©
const [fromNetwork, setFromNetwork] = useState<Network>("bnb")
const [toNetwork, setToNetwork] = useState<Network>("injective")

// ä»£å¸é€‰æ‹©
const [fromToken, setFromToken] = useState(bnbUsdtToken)
const [toToken, setToToken] = useState(injAxlUsdcToken)

// é‡‘é¢è¾“å…¥
const { register, handleSubmit } = useForm()

// æäº¤æ¡¥æ¥
const onSubmit = async (data: FormData) => {
  if (fromNetwork === "ethereum" && toNetwork === "injective") {
    await peggyEthDeposit({ amount: data.amount, token: fromToken })
  } else {
    await axelarEvmDeposit({ amount: data.amount, fromToken, toToken })
  }
}
```

---

### 2. CurrencyInputï¼ˆä»£å¸è¾“å…¥æ¡†ï¼‰

**æ–‡ä»¶**: `components/bridge/common/CurrencyInput.tsx`

**èŒè´£**ï¼š
- ä»£å¸é€‰æ‹©
- é‡‘é¢è¾“å…¥
- æ˜¾ç¤ºä½™é¢

```typescript
<CurrencyInput
  tokens={[ethUsdtToken, injToken]}
  selectedDenom={ethUsdtToken.denom}
  onSelectToken={(token) => setToken(token)}
  onAmountChange={(amount) => setAmount(amount)}
  balance={availableBalance}
/>
```

---

## ğŸ› ï¸ å·¥å…·å‡½æ•°

### bridge-utils.ts

**æ–‡ä»¶**: `lib/bridge/utils/bridge-utils.ts`

**ä¸»è¦å·¥å…·**ï¼š
```typescript
// Peggy Denom â†’ åˆçº¦åœ°å€
export function peggyDenomToContractAddress(denom: string): string

// è·å–äº¤æ˜“é€‰é¡¹
export function getTransactionOptions(): TransactionOptions

// è®¡ç®— Gas ä»·æ ¼
export function calculateGasPrice(network: Network): BigNumber
```

---

## ğŸ“– å®Œæ•´è°ƒç”¨é“¾ç¤ºä¾‹

```
ç”¨æˆ·ç‚¹å‡»"Bridge"
    â†“
BridgeFromV2.onSubmit()
    â†“
usePeggy().peggyEthDeposit()
    â†“
web3Composer.getPeggyDepositMsg()
    â†“
useWagmiContracts().sendToInjective()
    â†“
walletService.msgBroadcaster.broadcast()
    â†“
åŒºå—é“¾ç½‘ç»œ
```

---

## ğŸ“– ä¸‹ä¸€æ­¥

- ğŸ‘‰ [API å‚è€ƒ](./06-APIå‚è€ƒ.md) - è¯¦ç»† API æ–‡æ¡£
- ğŸ‘‰ [å¸¸è§é—®é¢˜](./07-å¸¸è§é—®é¢˜.md) - å¼€å‘å¸¸è§é—®é¢˜

---

*æœ€åæ›´æ–°: 2025-10-30*

